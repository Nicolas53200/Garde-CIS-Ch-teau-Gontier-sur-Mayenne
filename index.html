<!doctype html>
<html lang="fr" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rassemblement Garde Sapeurs-Pompiers</title>
  <script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&amp;family=Source+Sans+Pro:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    .font-display { font-family: 'Bebas Neue', sans-serif; }
    .font-body { font-family: 'Source Sans Pro', sans-serif; }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    .slide-active {
      animation: slideIn 0.6s ease-out forwards;
    }
    
    .personnel-card {
      transition: all 0.3s ease;
      cursor: move;
    }

    .personnel-card:hover {
      transform: translateY(-2px);
    }

    .drop-zone, .drop-zone-garde {
      transition: all 0.3s ease;
    }

    #saving-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    #saving-indicator.show {
      opacity: 1;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full font-body">
  <div id="saving-indicator"></div>
  <div id="app" class="h-full w-full"></div>
  
  <script>
  // ---- Google Sheets Data SDK (drop-in replacement for Canva data_sdk.js) ----
  // 1) Deploy the provided Google Apps Script as a Web App.
  // 2) Paste the Web App URL below:
  window.GSHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwzh2ECTZ3Uyfdqcq04DiACwhmwvtQM87jfWwMrepuDKU5cGNNbXMe9Bt0q3i6WnJeu/exec";

  (function(){
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

async function callApi(payload) {
  const baseUrl = window.GSHEETS_WEBAPP_URL;
  if (!baseUrl || baseUrl.includes("PASTE_YOUR_GOOGLE_APPS_SCRIPT_WEBAPP_URL_HERE")) {
    return { isOk:false, error:"GSHEETS_WEBAPP_URL not set" };
  }

  const action = payload && payload.action ? payload.action : "list";
  const record = payload && payload.record ? payload.record : null;

  const b64 = (str) => btoa(unescape(encodeURIComponent(str)));

  let url = `${baseUrl}?action=${encodeURIComponent(action)}&_ts=${Date.now()}`;

  if (record) {
    const packed = { record };
    url += `&payload=${encodeURIComponent(b64(JSON.stringify(packed)))}`;
  }

  return await new Promise((resolve) => {
    const cbName = `__gs_cb_${Date.now()}_${Math.floor(Math.random() * 1e9)}`;

    const cleanup = (script) => {
      try { delete window[cbName]; } catch(e) { window[cbName] = undefined; }
      if (script && script.parentNode) script.parentNode.removeChild(script);
    };

    const timeout = setTimeout(() => {
      cleanup(script);
      resolve({ isOk:false, error:"Timeout (no response from Apps Script)" });
    }, 12000);

    window[cbName] = (resp) => {
      clearTimeout(timeout);
      cleanup(script);

      if (resp && resp.ok) {
        resolve({ isOk:true, value: resp.data });
      } else {
        resolve({ isOk:false, error: (resp && resp.error) ? resp.error : "Unknown error" });
      }
    };

    const script = document.createElement("script");
    script.src = `${url}&callback=${encodeURIComponent(cbName)}`;
    script.onerror = () => {
      clearTimeout(timeout);
      cleanup(script);
      resolve({ isOk:false, error:"Network/Script load error (JSONP)" });
    };
    document.head.appendChild(script);
  });
}

    function stableHash(obj){
      try {
        return btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
      } catch(e) { return String(Math.random()); }
    }

    function makeSdk(){
      let handler = null;
      let pollMs = 2000;
      let timer = null;
      let lastHash = null;

      async function list(){
        return await callApi({ action:"list" });
      }

      async function tick(){
        if (!handler || !handler.onDataChanged) return;
        const r = await list();
        if (!r.isOk) return;
        const records = r.value || [];
        const h = stableHash(records.map(x => [x.__backendId, x.updatedAt, x.createdAt, x.id]));
        if (h !== lastHash){
          lastHash = h;
          handler.onDataChanged(records);
        }
      }

      return {
        async init(h){
          handler = h;
          // immediate load
          const first = await list();
          if (!first.isOk) return first;
          handler.onDataChanged(first.value || []);
          // start polling
          if (timer) clearInterval(timer);
          timer = setInterval(() => { tick(); }, pollMs);
          return { isOk:true, value:true };
        },
        async create(record){
          return await callApi({ action:"create", record });
        },
        async update(record){
          return await callApi({ action:"update", record });
        },
        async delete(record){
          return await callApi({ action:"delete", record });
        }
      };
    }

    // Expose as window.dataSdk
    window.dataSdk = window.dataSdk || makeSdk();
  })();
  </script>

<script>
    let currentRecords = [];
    let isInitialized = false;
    let isSaving = false;
    let isPannelOpen = false;
    let saveTimeouts = {};
    
    let sousOfficierGarde = [];
    let effectifGarde = [];
    let prochainDepart = [];
    let infirmiersGarde = [];
    let vehiculeAssignments = {};
    let progressInterval = null;
    let progressValue = 0;
    const SLIDE_DURATION = 20000;
    let selectedDayOfWeek = new Date().getDay();
    let autoPlayInterval = null;
    let isAutoPlaying = true;
    let progressAnimationFrame = null;
    let progressStartTime = null;
    
    let currentWeekOffset = 0;
    let calendarDate = new Date();
    
    function renderCalendar() {
      const fontSize = config.font_size;
      const date = new Date(calendarDate);
      const year = date.getFullYear();
      const month = date.getMonth();
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();
      
      const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
      const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const currentWeekDates = getWeekDates(currentWeekOffset);
      
      let html = `
        <div class="flex items-center justify-between mb-3">
          <button onclick="previousMonth(event)" 
                  class="px-3 py-1.5 rounded-lg font-bold transition-all hover:scale-110"
                  style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${fontSize * 0.5}px;">
            ‚Üê
          </button>
          <h3 class="font-display" style="font-size: ${fontSize * 0.8}px; color: ${config.text_color};">${monthNames[month]} ${year}</h3>
          <button onclick="nextMonth(event)" 
                  class="px-3 py-1.5 rounded-lg font-bold transition-all hover:scale-110"
                  style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${fontSize * 0.5}px;">
            ‚Üí
          </button>
        </div>
        <div class="grid grid-cols-7 gap-1 mb-2">
          ${dayNames.map(day => `
            <div class="text-center py-1" style="font-size: ${fontSize * 0.4}px; color: ${config.secondary_action_color}; font-weight: 600;">${day}</div>
          `).join('')}
        </div>
        <div class="grid grid-cols-7 gap-1">
      `;
      
      for (let i = 0; i < startDay; i++) {
        html += `<div></div>`;
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const currentDate = new Date(year, month, day);
        currentDate.setHours(0, 0, 0, 0);
        
        const isToday = currentDate.getTime() === today.getTime();
        const isInSelectedWeek = currentDate >= currentWeekDates.start && currentDate <= currentWeekDates.end;
        
        const dayOfWeek = currentDate.getDay();
        const isMonday = dayOfWeek === 1;
        
        let bgColor = config.background_color;
        let textColor = config.text_color;
        let borderColor = 'transparent';
        let fontWeight = '400';
        
        if (isInSelectedWeek) {
          bgColor = config.primary_action_color + '40';
          fontWeight = '600';
        }
        if (isToday) {
          borderColor = config.secondary_action_color;
          fontWeight = '700';
        }
        
        html += `
          <button onclick="selectWeekFromDay(${year}, ${month}, ${day})"
                  class="aspect-square rounded-lg transition-all hover:scale-110 ${isMonday ? 'ring-2' : ''}"
                  style="background: ${bgColor}; color: ${textColor}; font-size: ${fontSize * 0.45}px; border: 2px solid ${borderColor}; font-weight: ${fontWeight}; ${isMonday ? 'ring-color: ' + config.secondary_action_color + ';' : ''}">
            ${day}
          </button>
        `;
      }
      
      html += `</div>`;
      
      return html;
    }
    
    
    // --- Reservation Harmonie (affichage auto) ---
    function getHarmonieReservationDay() {
      const v = localStorage.getItem('harmonieReservationDay');
      return (v === null || v === '') ? 5 : Number(v); // 5=Vendredi par d√©faut
    }
    window.getHarmonieReservationDay = getHarmonieReservationDay;
    window.setHarmonieReservationDay = function(day) {
      localStorage.setItem('harmonieReservationDay', String(day));
      render();
    };

window.toggleCalendar = function() {
      const container = document.getElementById('calendar-container');
      const arrow = document.getElementById('calendar-arrow');
      if (container && arrow) {
        container.classList.toggle('hidden');
        arrow.style.transform = container.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
      }
    };
    
    window.previousMonth = function(event) {
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }
      calendarDate.setMonth(calendarDate.getMonth() - 1);
      const container = document.getElementById('calendar-container');
      const wasOpen = container && !container.classList.contains('hidden');
      render();
      if (wasOpen) {
        setTimeout(() => {
          const newContainer = document.getElementById('calendar-container');
          if (newContainer) newContainer.classList.remove('hidden');
          const arrow = document.getElementById('calendar-arrow');
          if (arrow) arrow.style.transform = 'rotate(180deg)';
        }, 0);
      }
    };
    
    window.nextMonth = function(event) {
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }
      calendarDate.setMonth(calendarDate.getMonth() + 1);
      const container = document.getElementById('calendar-container');
      const wasOpen = container && !container.classList.contains('hidden');
      render();
      if (wasOpen) {
        setTimeout(() => {
          const newContainer = document.getElementById('calendar-container');
          if (newContainer) newContainer.classList.remove('hidden');
          const arrow = document.getElementById('calendar-arrow');
          if (arrow) arrow.style.transform = 'rotate(180deg)';
        }, 0);
      }
    };
    
    window.selectWeekFromDay = function(year, month, day) {
      const selectedDate = new Date(year, month, day);
      selectedDate.setHours(12, 0, 0, 0);

      const currentMonday = mondayOfWeek(new Date());
      const selectedMonday = mondayOfWeek(selectedDate);

      const diffMs = selectedMonday.getTime() - currentMonday.getTime();
      const diffWeeks = Math.round(diffMs / (7 * 24 * 60 * 60 * 1000));

      currentWeekOffset = diffWeeks;

      // Keep calendar view on the chosen month
      calendarDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);

      render();
    };


    // ‚úÖ Navigation semaine (option A : l'utilisateur choisit la semaine)
    window.previousWeek = function() {
      currentWeekOffset -= 1;
      loadDataFromRecords(currentRecords);
      render();
    };
    window.nextWeek = function() {
      currentWeekOffset += 1;
      loadDataFromRecords(currentRecords);
      render();
    };
    window.goToCurrentWeek = function() {
      currentWeekOffset = 0;
      calendarDate = new Date();
      loadDataFromRecords(currentRecords);
      render();
    };
    
        function mondayOfWeek(dateLike) {
      const d = new Date(dateLike);
      // Use midday to avoid DST edge cases
      d.setHours(12, 0, 0, 0);
      const day = d.getDay(); // 0=Sun..6=Sat
      const diff = (day === 0 ? -6 : 1 - day); // bring back to Monday
      d.setDate(d.getDate() + diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function getWeekKey(weekOffset = 0) {
      const weekStart = mondayOfWeek(new Date());
      weekStart.setDate(weekStart.getDate() + (weekOffset * 7));
      return isoLocalDate(weekStart);
    }
    
    function getWeekDates(weekOffset = 0) {
      const weekStart = mondayOfWeek(new Date());
      weekStart.setDate(weekStart.getDate() + (weekOffset * 7));
      weekStart.setHours(0, 0, 0, 0);

      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekStart.getDate() + 6);
      weekEnd.setHours(0, 0, 0, 0);

      return {
        start: weekStart,
        end: weekEnd,
        key: isoLocalDate(weekStart)
      };
    }

    function formatWeekRange(weekOffset = 0) {
      const dates = getWeekDates(weekOffset);
      const options = { day: 'numeric', month: 'short' };
      const start = dates.start.toLocaleDateString('fr-FR', options);
      const end = dates.end.toLocaleDateString('fr-FR', options);
      const year = dates.start.getFullYear();
      return `${start} - ${end} ${year}`;
    }

    const availablePersonnel = [
      { grade: 'A/C', name: 'LE GALLIOT', type: 'SPP' },
      { grade: 'A/C', name: 'LETURGEON', type: 'SPP' },
      { grade: 'A/C', name: 'ROBERT', type: 'SPP' },
      { grade: 'Adjudant', name: 'HUET', type: 'SPP' },
      { grade: 'Adjudant', name: 'MOREL', type: 'SPP' },
      { grade: 'S/C', name: 'KERNEVEZ', type: 'SPP' },
      { grade: 'Sergent', name: 'BOUHOURS', type: 'SPP' },
      { grade: 'Sergent', name: 'FOURREAU', type: 'SPP' },
      { grade: 'Sergent', name: 'DUVAL', type: 'SPP' },
      { grade: 'Sergent', name: 'LECOMTE', type: 'SPP' },
      { grade: 'Caporal', name: 'BOURDIN', type: 'SPP' },
      { grade: 'Caporal', name: 'GIRAUX', type: 'SPP' },
      { grade: 'A/C', name: 'BELLANGER Philippe', type: 'SPV', equipe: '1' },
      { grade: 'A/C', name: 'COCAUD Mickael', type: 'SPV', equipe: '1' },
      { grade: 'A/C', name: 'MARCHAND Jimmy', type: 'SPV', equipe: '1' },
      { grade: 'S/C', name: 'COSSON Manuel', type: 'SPV', equipe: '1' },
      { grade: 'S/C', name: 'SIMON Adrien', type: 'SPV', equipe: '1' },
      { grade: 'Sergent', name: 'BLONDEEL Benoit', type: 'SPV', equipe: '1' },
      { grade: 'C/C', name: 'OBLIN Maxence', type: 'SPV', equipe: '1' },
      { grade: 'Caporal', name: 'BONNIER Th√©o', type: 'SPV', equipe: '1' },
      { grade: 'Caporal', name: 'BRICAUD J√©r√©my', type: 'SPV', equipe: '1' },
      { grade: 'Caporal', name: 'GARNIER Romain', type: 'SPV', equipe: '1' },
      { grade: 'Caporal', name: 'GILLE Maxime', type: 'SPV', equipe: '1' },
      { grade: 'Caporal', name: 'PRODHOMME Lucas', type: 'SPV', equipe: '1' },
      { grade: 'A/C', name: 'BOUVET Vincent', type: 'SPV', equipe: '2' },
      { grade: 'A/C', name: 'GIRAULT Antoine', type: 'SPV', equipe: '2' },
      { grade: 'A/C', name: 'GOHIER S√©bastien', type: 'SPV', equipe: '2' },
      { grade: 'A/C', name: 'MARTIN Vincent', type: 'SPV', equipe: '2' },
      { grade: 'S/C', name: 'NOUVEL Mathis', type: 'SPV', equipe: '2' },
      { grade: 'S/C', name: 'PAPION Cl√©ment', type: 'SPV', equipe: '2' },
      { grade: 'C/C', name: 'MARCHAND Alexandre', type: 'SPV', equipe: '2' },
      { grade: 'C/C', name: 'MOTTAIS Romain', type: 'SPV', equipe: '2' },
      { grade: 'Caporal', name: 'DEROUIN Faustine', type: 'SPV', equipe: '2' },
      { grade: 'Caporal', name: 'FARIBEAULT Samuel', type: 'SPV', equipe: '2' },
      { grade: 'Sapeur', name: 'BOSCHET Charlotte', type: 'SPV', equipe: '2' },
      { grade: 'Sapeur', name: 'GIRAULT Matt√©o', type: 'SPV', equipe: '2' },
      { grade: 'A/C', name: 'BERNARD Guillaume', type: 'SPV', equipe: '3' },
      { grade: 'A/C', name: 'HAY Ludovic', type: 'SPV', equipe: '3' },
      { grade: 'S/C', name: 'ALLEXANDRE Thierry', type: 'SPV', equipe: '3' },
      { grade: 'Sergent', name: 'DEJONGHE TALDIR Claire', type: 'SPV', equipe: '3' },
      { grade: 'Sergent', name: 'DUTERTRE Arnaud', type: 'SPV', equipe: '3' },
      { grade: 'C/C', name: 'BOITEAU Kevin', type: 'SPV', equipe: '3' },
      { grade: 'C/C', name: 'CHALINE Denovan', type: 'SPV', equipe: '3' },
      { grade: 'C/C', name: 'COCAUD Juliana', type: 'SPV', equipe: '3' },
      { grade: 'Caporal', name: 'BOURBON Mathieu', type: 'SPV', equipe: '3' },
      { grade: 'Sapeur', name: 'BOISBOUVIER Loriane', type: 'SPV', equipe: '3' },
      { grade: 'Sapeur', name: 'GODIOT Lucas', type: 'SPV', equipe: '3' },
      { grade: 'Sapeur', name: 'RANGEARD Lennie', type: 'SPV', equipe: '3' },
      { grade: 'A/C', name: 'BELLANGER David', type: 'SPV', equipe: '4' },
      { grade: 'A/C', name: 'PASQUIER Christophe', type: 'SPV', equipe: '4' },
      { grade: 'S/C', name: 'AUBERT Adrien', type: 'SPV', equipe: '4' },
      { grade: 'S/C', name: 'BRICHET Benoit', type: 'SPV', equipe: '4' },
      { grade: 'Sergent', name: 'PRODHOMME Romain', type: 'SPV', equipe: '4' },
      { grade: 'C/C', name: 'ESNAULT Xavier', type: 'SPV', equipe: '4' },
      { grade: 'C/C', name: 'HESLOIN Nicolas', type: 'SPV', equipe: '4' },
      { grade: 'C/C', name: 'LEPEC Kevin', type: 'SPV', equipe: '4' },
      { grade: 'Sapeur', name: 'BERTRON Lilou', type: 'SPV', equipe: '4' },
      { grade: 'Sapeur', name: 'CADOS Justin', type: 'SPV', equipe: '4' },
      { grade: 'Sapeur', name: 'TROVALLET Thomas', type: 'SPV', equipe: '4' },
      { grade: 'Sapeur', name: 'CHESNE Laurent', type: 'SPV', equipe: '4' }
    ];

    const defaultConfig = {
      background_color: '#1a1a2e',
      surface_color: '#16213e',
      text_color: '#ffffff',
      primary_action_color: '#dc2626',
      secondary_action_color: '#f59e0b',
      font_size: 28,
      centre_name: 'CIS CH√ÇTEAU-GONTIER-SUR-MAYENNE'
    };

    let config = { ...defaultConfig };
    let currentSlide = 0;

    const slides = [
      { id: 'garde', title: 'GARDE DU JOUR' },
      { id: 'verifications', title: 'V√âRIFICATIONS DU JOUR' },
      { id: 'activite', title: 'ACTIVIT√âS DE LA GARDE' },
      { id: 'gpro', title: 'CASERNEMENT' },
      { id: 'nouvelle', title: 'INFORMATIONS QUOTIDIENNES' },
      { id: 'gli', title: 'GLI' },
      { id: 'formation', title: 'FORMATION' },
      { id: 'communication', title: 'R√âPONSE OP√âRATIONNELLE / COMMUNICATION' },
      { id: 'divers', title: 'INFORMATIONS AMICALE' }
    ];

    function showSavingIndicator(message, isError = false) {
      const indicator = document.getElementById('saving-indicator');
      if (indicator) {
        indicator.textContent = message;
        indicator.style.background = isError ? config.primary_action_color : config.secondary_action_color;
        indicator.style.color = isError ? config.text_color : config.background_color;
        indicator.classList.add('show');
        setTimeout(() => {
          indicator.classList.remove('show');
        }, 2000);
      }
    }

    async function saveData(type, data) {
      if (isSaving) return;
      isSaving = true;
      showSavingIndicator('üíæ Sauvegarde en cours...');

      try {
// ‚úÖ Emp√™che data d'√©craser des champs critiques (type, dayOfWeek, weekKey, id)
const safeData = { ...data };
delete safeData.type;
delete safeData.dayOfWeek;
delete safeData.weekKey;
delete safeData.id;

const record = {
  id: `${type}_${selectedDayOfWeek}_${Date.now()}`,
  type: type,
  dayOfWeek: Number(selectedDayOfWeek),
  day_of_week: Number(selectedDayOfWeek),
  weekKey: weekKeyToMonday(getWeekKey(currentWeekOffset)),
  week_key: weekKeyToMonday(getWeekKey(currentWeekOffset)),
  ...safeData,
  createdAt: new Date().toISOString()
};


        const result = await window.dataSdk.create(record);
        
if (result.isOk) {
  showSavingIndicator('‚úì Sauvegard√©');

  // üî• Mise √† jour imm√©diate de l‚Äôinterface
  const created = result.value;
  if (created) {
    currentRecords = [...currentRecords, created];
    loadDataFromRecords(currentRecords);
    render();
  }
} else {
  console.error('Save error:', result.error);
  showSavingIndicator('‚úó Erreur de sauvegarde', true);
}
} catch (error) {
  console.error('Save error:', error);
  showSavingIndicator('‚úó Erreur de sauvegarde', true);
} finally {
  isSaving = false;
}
}

    async function updateData(record) {
      if (isSaving) return;
      isSaving = true;
      showSavingIndicator('üíæ Mise √† jour...');

      try {
        const result = await window.dataSdk.update(record);
        
if (result.isOk) {
  showSavingIndicator('‚úì Mis √† jour');

  // üî• Mise √† jour imm√©diate de l‚Äôinterface
  const row = Number(record.__backendId);
  currentRecords = currentRecords.map(r =>
    Number(r.__backendId) === row ? { ...r, ...record } : r
  );
  loadDataFromRecords(currentRecords);
  render();

} else {
  console.error('Update error:', result.error);
  showSavingIndicator('‚úó Erreur de mise √† jour', true);
}

      } catch (error) {
        console.error('Update error:', error);
        showSavingIndicator('‚úó Erreur de mise √† jour', true);
      } finally {
        isSaving = false;
      }
    }

    async function deleteData(record) {
      if (isSaving) return;
      isSaving = true;
      showSavingIndicator('üóëÔ∏è Suppression...');

      try {
        const result = await window.dataSdk.delete({ __backendId: record.__backendId });
        
if (result.isOk) {
  showSavingIndicator('‚úì Supprim√©');

  // üî• Mise √† jour imm√©diate de l‚Äôinterface
  const row = Number(record.__backendId);
  currentRecords = currentRecords.filter(r => Number(r.__backendId) !== row);
  loadDataFromRecords(currentRecords);
  render();

} else {
  console.error('Delete error:', result.error);
  showSavingIndicator('‚úó Erreur de suppression', true);
}

      } catch (error) {
        console.error('Delete error:', error);
        showSavingIndicator('‚úó Erreur de suppression', true);
      } finally {
        isSaving = false;
      }
    }
function normalizeWeekKey(v) {
  if (v == null || v === '') return null;

  // Si c'est d√©j√† du type "YYYY-MM-DD" => ok
  if (typeof v === 'string') {
    const s = v.trim();

    // ‚úÖ Cas critique : ISO avec heure / timezone (ex: "2026-02-01T23:00:00.000Z")
    // On parse en Date puis on repasse en date locale pour √©viter de tomber sur la veille.
    if (/[Tt]/.test(s) || /Z$/.test(s) || /[\+\-]\d{2}:?\d{2}$/.test(s)) {
      const dIso = new Date(s);
      if (!isNaN(dIso.getTime())) return isoLocalDate(dIso);
    }

    const iso = s.match(/^(\d{4}-\d{2}-\d{2})/);
    if (iso) return iso[1];

    // ‚úÖ Cas FR "dd/mm/yyyy"
    const fr = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (fr) {
      const dd = Number(fr[1]);
      const mm = Number(fr[2]);
      const yyyy = Number(fr[3]);
      const d = new Date(yyyy, mm - 1, dd);
      return isoLocalDate(d);
    }

    // Autres formats lisibles (ex: "Tue Feb 03 2026...")
    const d = new Date(s);
    if (!isNaN(d.getTime())) return isoLocalDate(d);

    return s;
  }

  if (v instanceof Date) return isoLocalDate(v);

  return String(v);
}

function isoLocalDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}



// --- Helpers: robust comparisons (trim/case-insensitive) ---
function normStr(v){ return (v==null ? '' : String(v)).trim().toLowerCase(); }
function sameName(a,b){ return normStr(a) === normStr(b); }
function sameBackendId(a,b){
  if (a==null || b==null) return false;
  return String(a).trim() === String(b).trim();
}
/* ‚úÖ COLLE ICI */
function weekKeyToMonday(v) {
  const s = normalizeWeekKey(v);
  if (!s) return null;

  // On parse √† midi pour √©viter les d√©calages de fuseau horaire
  const d = new Date(s + "T12:00:00");
  if (isNaN(d.getTime())) return s;

  const day = d.getDay(); // 0=dimanche, 1=lundi, ...
  const diff = (day === 0 ? -6 : 1 - day); // ram√®ne au lundi
  d.setDate(d.getDate() + diff);

  return isoLocalDate(d);
}
/* ‚úÖ FIN DU COLLER */

// --- Helpers for recurring weekly/monthly items ---
function getSelectedDateForCurrentView() {
  const wk = getWeekDates(currentWeekOffset);
  const monday = new Date(wk.start);
  const idx = (Number(selectedDayOfWeek) === 0) ? 6 : (Number(selectedDayOfWeek) - 1); // Monday=0..Sunday=6
  const d = new Date(monday);
  d.setDate(monday.getDate() + idx);
  d.setHours(0,0,0,0);
  return d;
}

// ISO week number (1..53), based on ISO-8601 (week starts Monday)
function getISOWeekNumber(date) {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  // Thursday in current week decides the year.
  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return weekNo;
}


// --- Helpers to read day/week keys robustly from backend records ---
function getRecordDayOfWeek(record) {
  const v = (record && (record.dayOfWeek ?? record.day_of_week ?? record.jour ?? record.dow));
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function getRecordWeekKey(record) {
  const v = (record && (record.weekKey ?? record.week_key ?? record.semaine ?? record.week));
  return weekKeyToMonday(v);
}


    function loadDataFromRecords(data) {
      console.log('');
      console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêÔøΩÔøΩÔøΩ‚ïê‚ïó');
      console.log('‚ïë          CHARGEMENT DES DONN√âES (loadDataFromRecords)         ‚ïë');
      console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêÔøΩÔøΩÔøΩ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêÔøΩÔøΩÔøΩ‚ïù');
      console.log('Jour s√©lectionn√© (selectedDayOfWeek):', selectedDayOfWeek);
      console.log('Semaine s√©lectionn√©e (currentWeekOffset):', currentWeekOffset);
      console.log('Cl√© de semaine (weekKey):', normalizeWeekKey(getWeekKey(currentWeekOffset)));
      console.log('Nombre total de records:', data.length);
      console.log('');
      
      // R√©initialiser TOUTES les donn√©es sp√©cifiques au jour s√©lectionn√©
      console.log('üßπ R√âINITIALISATION des donn√©es de garde...');
      sousOfficierGarde = [];
      effectifGarde = [];
      prochainDepart = [];
      infirmiersGarde = [];
      vehiculeAssignments = {};
      
      if (!window.voiesBarreesList) window.voiesBarreesList = [];
      if (!window.reservationSalleList) window.reservationSalleList = [];
      if (!window.diversGproList) window.diversGproList = [];
      if (!window.enginsIndispoList) window.enginsIndispoList = [];
      if (!window.presenceMedicalList) window.presenceMedicalList = [];
      
      window.voiesBarreesList = [];
      window.reservationSalleList = [];
      window.reservationSalle = '';
      window.diversGproList = [];
      window.enginsIndispoList = [];
      window.tigDivers = '';
      window.tigChecked = {};
      window.tigGproChecked = {};
      window.tigCasernementChecked = {};
      window.tigCasernementDivers = '';
      window.tigGproDivers = '';
      window.tigVendrediChecked = {};
      window.tigVendrediDivers = '';
      window.formationNotes = '';
      window.reponseOpNotes = '';
      window.diversNotes = '';
      window.amicaleNotes = '';
      window.gliNotes = '';
      window.nouvelleNotes = '';
      window.apprenantNom = '';
      window.apprenantCreneau = '';
      window.enginsIndispo = '';
      window.materielDefect = '';
      window.verificationsWeekend = '';
      window.activitePhysique = '';
      window.activitePhysiqueType = '';
      window.activitePhysiqueCreneau = '';
      window.manoeuvreGarde = '';
      
      console.log('‚úÖ R√©initialisation termin√©e');
      console.log('   - sousOfficierGarde:', sousOfficierGarde.length);
      console.log('   - effectifGarde:', effectifGarde.length);
      console.log('   - prochainDepart:', prochainDepart.length);
      console.log('');

 	const currentWeekKey = weekKeyToMonday(getWeekKey(currentWeekOffset));
      const currentWeekKeyNorm = weekKeyToMonday(currentWeekKey);

      
      const selectedDate = new Date();
      const currentDayOfWeek = selectedDate.getDay();
      const daysFromMonday = currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1;
      selectedDate.setDate(selectedDate.getDate() - daysFromMonday + (currentWeekOffset * 7));
      
      const targetDayOfWeek = selectedDayOfWeek;
      const daysToAdd = targetDayOfWeek === 0 ? 6 : targetDayOfWeek - 1;
      selectedDate.setDate(selectedDate.getDate() - (selectedDate.getDay() === 0 ? 6 : selectedDate.getDay() - 1) + daysToAdd);
      selectedDate.setHours(0, 0, 0, 0);
      
      console.log('üîç ANALYSE DES RECORDS...');
      console.log('');
      
      // Filtrer les donn√©es STRICTEMENT pour le jour ET la semaine s√©lectionn√©s
      data.forEach(record => {
        // Normalisation robuste des champs venant de Google Sheets
        const recordDayOfWeek = getRecordDayOfWeek(record);
        const recordWeekKeyRaw = getRecordWeekKey(record);
        const recordWeekKey = recordWeekKeyRaw || currentWeekKey; // compat: anciens enregistrements sans weekKey

        // On recopie (optionnel) pour faciliter le debug / la coh√©rence interne
        record.dayOfWeek = recordDayOfWeek;
        record.weekKey = recordWeekKey;

        
        // R√àGLE ABSOLUE : Pour les donn√©es de garde (personnel assign√©), 
        // n'afficher QUE si dayOfWeek ET weekKey correspondent EXACTEMENT
        if (['sous_officier', 'effectif', 'depart', 'infirmier', 'verification'].includes(record.type)) {
          console.log(`ÔøΩÔøΩÔøΩÔøΩ Record de garde trouv√©:`, {
            type: record.type,
            nom: record.nom,
            dayOfWeek: recordDayOfWeek,
            weekKey: recordWeekKey,
            matchDayOfWeek: recordDayOfWeek === selectedDayOfWeek,
            matchWeekKey: recordWeekKey === currentWeekKeyNorm
          });
          
          // V√©rification stricte : dayOfWeek ET weekKey doivent correspondre EXACTEMENT
          if (recordDayOfWeek !== selectedDayOfWeek || recordWeekKey !== currentWeekKey) {
            console.log(`   ‚ùå IGNOR√â - Ne correspond pas au jour/semaine actuel`);
            return; // Ignorer compl√®tement - ne correspond pas au jour/semaine actuel
          }
          
          console.log(`   ‚úÖ CHARG√â - Correspond au jour/semaine actuel`);
          
          // Charger les donn√©es seulement si elles correspondent au jour ET semaine actuels
          if (record.type === 'sous_officier') {
            sousOfficierGarde.push({ nom: record.nom, grade: record.grade || '' });
            console.log(`      ‚Üí Ajout√© √† sousOfficierGarde`);
          } else if (record.type === 'effectif') {
            effectifGarde.push({
              nom: record.nom,
              grade: record.grade || '',
              creneau: record.creneau || '',
              isSupplementaire: record.isSupplementaire || false
            });
            console.log(`      ‚Üí Ajout√© √† effectifGarde`);
          } else if (record.type === 'depart') {
            prochainDepart.push({ nom: record.nom, grade: record.grade || '' });
            console.log(`      ‚Üí Ajout√© √† prochainDepart`);
          } else if (record.type === 'infirmier') {
            infirmiersGarde.push({
              nom: record.nom,
              creneau: record.creneau || '08h00 - 20h00'
            });
            console.log(`      ‚Üí Ajout√© √† infirmiersGarde`);
          } else if (record.type === 'verification') {
            const vehiculeId = record.zone;
            if (!vehiculeAssignments[vehiculeId]) {
              vehiculeAssignments[vehiculeId] = [];
            }
            vehiculeAssignments[vehiculeId].push(record.nom);
            console.log(`      ‚Üí Ajout√© aux v√©rifications (${vehiculeId})`);
          }
          return;
        }
        
        // Pour le personnel disponible (pas sp√©cifique √† un jour)
        if (record.type === 'personnel') {
          const existingIndex = availablePersonnel.findIndex(p => p.name === record.nom && p.type === (record.personType || 'SPV'));
          if (existingIndex === -1) {
            availablePersonnel.push({
              grade: record.grade || 'Sapeur',
              name: record.nom,
              type: record.personType || 'SPV',
              equipe: record.equipe || null
            });
          }
          return;
        }
        
        // Pour les notes et autres donn√©es
        if (record.type === 'notes') {
          if (record.zone === 'voiesBarrees' || record.zone === 'presenceMedicalList' || record.zone === 'presenceMedical' ||record.zone === 'diversGpro' || record.zone === 'reservationSalle' || record.zone === 'enginsIndispo') {
            const dateDebut = record.creneau ? new Date(record.creneau) : null;
            const dateFin = record.grade ? new Date(record.grade) : null;
            
            if (dateDebut) dateDebut.setHours(0, 0, 0, 0);
            if (dateFin) dateFin.setHours(0, 0, 0, 0);
            
            // Si aucune date n'est d√©finie, ne pas afficher (date d√©but obligatoire)
            if (!dateDebut) return;
            
            // V√©rifier si la date s√©lectionn√©e est dans la plage
            let isInRange = false;
            if (dateFin) {
              // Plage de dates : du d√©but √† la fin
              isInRange = selectedDate >= dateDebut && selectedDate <= dateFin;
            } else {
              // Seulement date de d√©but : afficher √† partir de cette date
              isInRange = selectedDate >= dateDebut;
            }
            
            if (!isInRange) return;
            
            const item = {
              id: record.id,
              __backendId: record.__backendId,
              texte: record.notes,
              dateDebut: record.creneau || '',
              dateFin: record.grade || ''
            };
            
            if (record.zone === 'voiesBarrees') {
              window.voiesBarreesList.push(item);
            } else if (record.zone === 'reservationSalle') {
              window.reservationSalleList.push(item);
            } else if (record.zone === 'diversGpro') {
              window.diversGproList.push(item);
            } else if (record.zone === 'enginsIndispo') {
              window.enginsIndispoList.push(item);
            } else if (record.zone === 'presenceMedicalList' || record.zone === 'presenceMedical') {
              window.presenceMedicalList.push(item);
            }
            return;
          }
          
          // Zones sp√©cifiques √† un jour (n√©cessitent dayOfWeek ET weekKey)
          const daySpecificZones = ['tigDivers', 'tigChecked', 'enginsIndispo', 'materielDefect', 'verificationsWeekend', 'tigGproChecked', 'tigGproDivers', 'tigVendrediChecked', 'tigVendrediDivers', 'apprenantNom', 'apprenantCreneau', 'activitePhysiqueType', 'activitePhysiqueCreneau', 'manoeuvreGarde', 'tigCasernementChecked', 'tigCasernementDivers'];
          if (daySpecificZones.includes(record.zone)) {
            if (record.dayOfWeek !== selectedDayOfWeek || record.weekKey !== currentWeekKey) {
              return; // Ignorer si le jour ou la semaine ne correspond pas
            }
          }
          
          // Traiter les diff√®rents types de notes
          if (record.zone === 'tigChecked') {
            try {
              window.tigChecked = JSON.parse(record.notes);
            } catch (e) {
              window.tigChecked = {};
            }
          } else if (record.zone === 'tigGproChecked') {
            try {
              window.tigGproChecked = JSON.parse(record.notes);
            } catch (e) {
              window.tigGproChecked = {};
            }
          } else if (record.zone === 'tigCasernementChecked') {
            try {
              window.tigCasernementChecked = JSON.parse(record.notes);
            } catch (e) {
              window.tigCasernementChecked = {};
            }
          } else if (record.zone === 'tigVendrediChecked') {
            try {
              window.tigVendrediChecked = JSON.parse(record.notes);
            } catch (e) {
              window.tigVendrediChecked = {};
            }
          } else {
            window[record.zone] = record.notes;
          }
        }
      });
      
      console.log('');
      console.log('üìä R√âSUM√â APR√àS CHARGEMENT:');
      console.log('   - sousOfficierGarde:', sousOfficierGarde.length, 'personne(s)', sousOfficierGarde);
      console.log('   - effectifGarde:', effectifGarde.length, 'personne(s)', effectifGarde);
      console.log('   - prochainDepart:', prochainDepart.length, 'personne(s)', prochainDepart);
      console.log('   - infirmiersGarde:', infirmiersGarde.length, 'personne(s)', infirmiersGarde);
      console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïêÔøΩÔøΩ‚ïê‚ïê‚ïê‚ïê‚ïù');
      console.log('');
    }

    function getCurrentDate() {
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      return new Date().toLocaleDateString('fr-FR', options);
    }

    function getCurrentTime() {
      return new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    }

    function startClock() {
      setInterval(() => {
        const clock = document.getElementById('clock');
        if (clock) clock.textContent = getCurrentTime();
      }, 1000);
    }

    function renderGardeSlide() {
      const fontSize = config.font_size;
      const joursSemaine = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
      
      const currentWeekKey = weekKeyToMonday(getWeekKey(currentWeekOffset));

const normName = (s) => (s || '').toString().trim().toLowerCase();

const assignedPersonnel = new Set();

currentRecords.forEach(record => {
  if (
    record.type === 'sous_officier' ||
    record.type === 'effectif' ||
    record.type === 'depart' ||
    record.type === 'infirmier' ||
    record.type === 'verification'
  ) {
    const rdow = getRecordDayOfWeek(record);
    const rwk = getRecordWeekKey(record);

    const isDayMatch = rdow !== null && Number(rdow) === Number(selectedDayOfWeek);
    const isWeekMatch = rwk !== null && rwk === currentWeekKey;

    if (isDayMatch && isWeekMatch) {
      assignedPersonnel.add(normName(record.nom));
    }
  }
});
      
      return `
        <div class="h-full flex gap-4">
          <div class="flex-1 flex flex-col">
            <div class="mb-3">
              <div class="flex items-center justify-between mb-2 gap-2">
            <div class="flex items-center gap-2">
              <button onclick="previousWeek()" 
                      class="px-3 py-2 rounded-lg font-bold transition-all duration-300 hover:scale-110"
                      style="background: ${config.surface_color}; color: ${config.text_color}; font-size: ${fontSize * 0.45}px; border: 2px solid ${config.text_color}40;">
                ‚Üê Semaine
              </button>
              <button onclick="goToCurrentWeek()"
                      class="px-3 py-2 rounded-lg font-bold transition-all duration-300 hover:scale-110"
                      style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${fontSize * 0.45}px;">
                Aujourd'hui
              </button>
              <button onclick="nextWeek()"
                      class="px-3 py-2 rounded-lg font-bold transition-all duration-300 hover:scale-110"
                      style="background: ${config.surface_color}; color: ${config.text_color}; font-size: ${fontSize * 0.45}px; border: 2px solid ${config.text_color}40;">
                Semaine ‚Üí
              </button>
            </div>
            <button onclick="toggleCalendar()" 
                    class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 flex items-center gap-2"
                    style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${fontSize * 0.5}px;">
              üóìÔ∏è ${formatWeekRange(currentWeekOffset)}
              <span id="calendar-arrow" style="transition: transform 0.3s;">‚ñº</span>
            </button>
          </div>
          <div id="calendar-container" class="hidden mb-2 rounded-xl p-4" onclick="event.stopPropagation()" style="background: ${config.surface_color}; border: 2px solid ${config.secondary_action_color};">
                ${renderCalendar()}
              </div>
              
              <div class="flex gap-1">
                ${[1, 2, 3, 4, 5, 6, 0].map((index) => {
                  const weekDates = getWeekDates(currentWeekOffset);
                  const currentDate = new Date(weekDates.start);
                  const dayOfWeek = currentDate.getDay();
                  const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                  currentDate.setDate(currentDate.getDate() - daysFromMonday);
                  
                  const targetDaysFromMonday = index === 0 ? 6 : index - 1;
                  const targetDate = new Date(currentDate);
                  targetDate.setDate(currentDate.getDate() + targetDaysFromMonday);
                  
                  const dateStr = targetDate.getDate().toString().padStart(2, '0') + '/' + (targetDate.getMonth() + 1).toString().padStart(2, '0');
                  
                  return `
                  <button onclick="selectDayOfWeek(${index})"
                          class="px-3 py-1.5 rounded-lg font-semibold transition-all duration-300 hover:scale-105 flex flex-col items-center"
                          style="background: ${selectedDayOfWeek === index ? config.primary_action_color : config.surface_color}; color: ${config.text_color}; font-size: ${fontSize * 0.5}px; border: 2px solid ${selectedDayOfWeek === index ? config.primary_action_color : config.text_color}40;">
                    <span>${joursSemaine[index]}</span>
                    <span style="font-size: ${fontSize * 0.4}px; opacity: 0.8;">${dateStr}</span>
                  </button>
                `}).join('')}
              </div>
            </div>
            
            <div class="grid grid-cols-4 gap-3 mb-3">
              <div class="rounded-xl p-3 drop-zone-garde" data-zone="sous_officier" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
                <p class="uppercase tracking-wide mb-2" style="font-size: ${fontSize * 0.5}px; color: ${config.secondary_action_color}; font-weight: 600;">Sous-Officier de Garde</p>
                <div id="sous-officier-zone" class="min-h-[40px]">
                  ${sousOfficierGarde.map(so => `
                    <div class="rounded-lg p-2 mb-1 flex items-center justify-between group" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                      <p style="font-size: ${fontSize * 0.6}px; color: ${config.text_color}; font-weight: 600;">${so.grade} ${so.nom}</p>
                      <button onclick="removeSousOfficier('${so.nom}')" 
                              class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-5 h-5 flex items-center justify-center hover:scale-110"
                              style="background: ${config.primary_action_color}; color: ${config.text_color};">
                        <span style="font-size: ${fontSize * 0.5}px;">√ó</span>
                      </button>
                    </div>
                  `).join('') || `<p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}40; text-align: center; padding: 8px;">Glissez un sapeur ici</p>`}
                </div>
              </div>

              <div class="col-span-2 rounded-xl p-3 drop-zone-garde" data-zone="effectif" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
                <p class="uppercase tracking-wide mb-2" style="font-size: ${fontSize * 0.5}px; color: ${config.secondary_action_color}; font-weight: 600;">Effectif de Garde (${effectifGarde.length}/10)</p>
                <div id="effectif-zone" class="grid grid-cols-2 gap-3">
                  <div>
                    <p class="uppercase tracking-wide mb-2" style="font-size: ${fontSize * 0.45}px; color: ${config.secondary_action_color}80; font-weight: 600;">Sous-Officiers</p>
                    <div class="space-y-1">
                      ${effectifGarde.filter(sapeur => {
                        const grade = sapeur.grade.toLowerCase();
                        return grade.includes('sergent') || grade.includes('s/c') || grade.includes('adjudant') || grade.includes('a/c');
                      }).map((sapeur) => `
                        <div draggable="true" 
                             ondragstart="handleDragStart(event, '${sapeur.nom}', '${sapeur.grade}')"
                             class="rounded-lg p-2 group flex items-center justify-between cursor-move" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                          <div class="flex-1">
                            <p style="font-size: ${fontSize * 0.55}px; color: ${config.text_color}; font-weight: 600;">${sapeur.grade} ${sapeur.nom}${sapeur.isSupplementaire ? ' <span style="color: ' + config.secondary_action_color + '; font-size: ' + (fontSize * 0.45) + 'px;">(Supp.)</span>' : ''}</p>
                            ${sapeur.creneau ? `<p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}60;">${sapeur.creneau}</p>` : ''}
                          </div>
                          <button onclick="removeEffectif('${sapeur.nom}')" 
                                  class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-4 h-4 flex items-center justify-center hover:scale-110 ml-2"
                                  style="background: ${config.primary_action_color}; color: ${config.text_color};">
                            <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                          </button>
                        </div>
                      `).join('') || `<p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}40; font-style: italic; text-align: center; padding: 8px;">Aucun</p>`}
                    </div>
                  </div>
                  
                  <div>
                    <p class="uppercase tracking-wide mb-2" style="font-size: ${fontSize * 0.45}px; color: ${config.secondary_action_color}80; font-weight: 600;">Hommes du Rang</p>
                    <div class="space-y-1">
                      ${effectifGarde.filter(sapeur => {
                        const grade = sapeur.grade.toLowerCase();
                        return !grade.includes('sergent') && !grade.includes('s/c') && !grade.includes('adjudant') && !grade.includes('a/c');
                      }).map((sapeur) => `
                        <div draggable="true" 
                             ondragstart="handleDragStart(event, '${sapeur.nom}', '${sapeur.grade}')"
                             class="rounded-lg p-2 group flex items-center justify-between cursor-move" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                          <div class="flex-1">
                            <p style="font-size: ${fontSize * 0.55}px; color: ${config.text_color}; font-weight: 600;">${sapeur.grade} ${sapeur.nom}${sapeur.isSupplementaire ? ' <span style="color: ' + config.secondary_action_color + '; font-size: ' + (fontSize * 0.45) + 'px;">(Supp.)</span>' : ''}</p>
                            ${sapeur.creneau ? `<p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}60;">${sapeur.creneau}</p>` : ''}
                          </div>
                          <button onclick="removeEffectif('${sapeur.nom}')" 
                                  class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-4 h-4 flex items-center justify-center hover:scale-110 ml-2"
                                  style="background: ${config.primary_action_color}; color: ${config.text_color};">
                            <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                          </button>
                        </div>
                      `).join('') || `<p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}40; font-style: italic; text-align: center; padding: 8px;">Aucun</p>`}
                    </div>
                  </div>
                </div>
              </div>

              <div class="rounded-xl p-3" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color};">
                <p class="uppercase tracking-wide mb-2" style="font-size: ${fontSize * 0.5}px; color: ${config.primary_action_color}; font-weight: 600;">Apprenant de Garde</p>
                <div class="flex flex-col gap-2">
                  <input type="text" 
                         id="apprenant-nom-input" 
                         value="${window.apprenantNom || ''}"
                         onchange="updateApprenantNom(this.value)"
                         placeholder="Nom de l'apprenant"
                         class="w-full rounded px-2 py-1.5 focus:outline-none focus:ring-2"
                         style="background: ${config.background_color}; font-size: ${fontSize * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40; font-weight: 600;">
                  <textarea id="apprenant-creneau-input"
                            onchange="updateApprenantCreneau(this.value)"
                            placeholder="Cr√©neau / Tuteur"
                            class="w-full rounded px-2 py-1.5 focus:outline-none focus:ring-2 resize-none"
                            rows="3"
                            style="background: ${config.background_color}; font-size: ${fontSize * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">${window.apprenantCreneau || ''}</textarea>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-3 flex-1">
              <div class="rounded-xl p-3 drop-zone-garde" data-zone="depart" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
                <p class="uppercase tracking-wide mb-2" style="font-size: ${fontSize * 0.5}px; color: ${config.secondary_action_color}; font-weight: 600;">Prochain D√©part VSAV (${prochainDepart.length}/3)</p>
                <div id="depart-zone" class="space-y-1">
                  ${prochainDepart.map(depart => `
                    <div class="rounded-lg p-2 group flex items-center justify-between" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                      <p style="font-size: ${fontSize * 0.55}px; color: ${config.text_color}; font-weight: 600;">${depart.grade} ${depart.nom}</p>
                      <button onclick="removeDepart('${depart.nom}')" 
                              class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-4 h-4 flex items-center justify-center hover:scale-110"
                              style="background: ${config.primary_action_color}; color: ${config.text_color};">
                        <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                      </button>
                    </div>
                  `).join('') || `<p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}40; text-align: center; padding: 8px;">Glissez des sapeurs ici</p>`}
                </div>
              </div>

              <div class="rounded-xl p-3" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
                <div class="flex items-center justify-between mb-2">
                  <p class="uppercase tracking-wide" style="font-size: ${fontSize * 0.5}px; color: ${config.secondary_action_color}; font-weight: 600;">Infirmiers de Garde (${infirmiersGarde.length})</p>
                  <button onclick="toggleInfirmierSelect()" 
                          class="rounded-full w-6 h-6 flex items-center justify-center transition-all duration-300 hover:scale-110"
                          style="background: ${config.secondary_action_color}; color: ${config.background_color};">
                    <span style="font-size: ${fontSize * 0.7}px; font-weight: bold;">+</span>
                  </button>
                </div>
                <div id="infirmier-select-container" class="hidden mb-2">
                  <select onchange="addInfirmierFromList(this.value); this.value='';" 
                          class="w-full rounded px-2 py-1.5 focus:outline-none focus:ring-2"
                          style="background: ${config.background_color}; font-size: ${fontSize * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}; font-weight: 600;">
                    <option value="">S√©lectionner un infirmier...</option>
                    <option value="Laurent RICHARD">Laurent RICHARD</option>
                    <option value="Fr√©d√©ric TALDIR">Fr√©d√©ric TALDIR</option>
                    <option value="Lou HERBELIN DUFOURT">Lou HERBELIN DUFOURT</option>
                    <option value="Gw√©na√´lle CHENU MENAGER">Gw√©na√´lle CHENU MENAGER</option>
                    <option value="Charl√®ne VIOT">Charl√®ne VIOT</option>
                    <option value="Marl√®ne ROUGER">Marl√®ne ROUGER</option>
                    <option value="Justine PHILIPPOT">Justine PHILIPPOT</option>
                    <option value="Mathieu TROVALLET">Mathieu TROVALLET</option>
                  </select>
                </div>
                <div class="space-y-1 overflow-auto" style="max-height: 300px;">
                  ${infirmiersGarde.length > 0 ? infirmiersGarde.map((infirmier) => `
                    <div class="rounded-lg p-2 group" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                      <div class="flex items-center justify-between mb-1">
                        <p class="flex-1" style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}; font-weight: 600;">${infirmier.nom}</p>
                        <button onclick="removeInfirmier('${infirmier.nom}')" 
                                class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-4 h-4 flex items-center justify-center hover:scale-110"
                                style="background: ${config.primary_action_color}; color: ${config.text_color};">
                          <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                        </button>
                      </div>
                      <input type="text" 
                             value="${infirmier.creneau}"
                             oninput="updateInfirmierCreneau('${infirmier.nom}', this.value)"
                             placeholder="Ex: 08h00 - 20h00"
                             class="w-full rounded px-1.5 py-1 focus:outline-none focus:ring-2"
                             style="background: ${config.surface_color}; font-size: ${fontSize * 0.45}px; color: ${config.text_color}80; border: 1px solid ${config.secondary_action_color}40;">
                    </div>
                  `).join('') : `<p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}60; text-align: center; padding: 8px;">Cliquez sur + pour ajouter un infirmier</p>`}
                </div>
              </div>
            </div>
          </div>

          <div class="w-80 rounded-xl p-4 flex flex-col" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color}; max-height: 100%; overflow-y: auto;">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-display tracking-wider" style="font-size: ${fontSize * 0.8}px; color: ${config.text_color};">Personnel Disponible</h3>
              <button onclick="addNewPersonnel()" 
                      class="rounded-full w-7 h-7 flex items-center justify-center transition-all duration-300 hover:scale-110"
                      style="background: ${config.secondary_action_color}; color: ${config.background_color};">
                <span style="font-size: ${fontSize * 0.7}px; font-weight: bold;">+</span>
              </button>
            </div>
            <div class="grid grid-cols-2 gap-3 overflow-y-auto">
              <div>
                <button onclick="toggleSppMenu()" 
                        class="w-full flex items-center justify-between p-2 rounded-lg mb-2 transition-all hover:scale-[1.02]"
                        style="background: ${config.primary_action_color}; color: ${config.text_color};">
                  <span style="font-size: ${fontSize * 0.5}px; font-weight: 700;">SPP</span>
                  <span id="spp-arrow" style="font-size: ${fontSize * 0.6}px; transition: transform 0.3s; transform: ${sppMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)'};">‚ñº</span>
                </button>
                <div id="spp-menu" class="space-y-3" style="display: ${sppMenuOpen ? 'block' : 'none'};">
                  <div>
                    <button onclick="toggleSppGrade('sousofficiers')" 
                            class="w-full flex items-center justify-between p-1.5 rounded mb-1 transition-all hover:scale-[1.02]"
                            style="background: ${config.background_color}; color: ${config.text_color};">
                      <span style="font-size: ${fontSize * 0.4}px; font-weight: 600;">Sous-Officiers</span>
                      <span id="spp-sousofficiers-arrow" style="font-size: ${fontSize * 0.5}px; transition: transform 0.3s; transform: ${sppGradeStates['sousofficiers'] ? 'rotate(180deg)' : 'rotate(0deg)'};">‚ñº</span>
                    </button>
                    <div id="spp-sousofficiers" class="space-y-1" style="display: ${sppGradeStates['sousofficiers'] ? 'block' : 'none'};">
                      ${availablePersonnel.filter(p => p.type === 'SPP' && (p.grade.toLowerCase().includes('sergent') || p.grade.toLowerCase().includes('s/c') || p.grade.toLowerCase().includes('adjudant') || p.grade.toLowerCase().includes('a/c')) && !assignedPersonnel.has(normName(p.name))
).map(person => `
                        <div draggable="true" 
                             ondragstart="handleDragStart(event, '${person.name}', '${person.grade}')"
                             class="personnel-card rounded-lg p-1.5 cursor-move group relative"
                             style="background: ${config.background_color}; border-left: 3px solid ${config.primary_action_color};">
                          <p style="font-size: ${fontSize * 0.42}px; color: ${config.text_color}; font-weight: 600;">${person.grade} ${person.name}</p>
                          <button onclick="event.stopPropagation(); deletePersonnel('${person.name}')" 
                                  class="opacity-0 group-hover:opacity-100 transition-opacity absolute top-1 right-1 rounded-full w-4 h-4 flex items-center justify-center hover:scale-110"
                                  style="background: ${config.primary_action_color}; color: ${config.text_color};">
                            <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                          </button>
                        </div>
                      `).join('')}
                    </div>
                  </div>

                  <div>
                    <button onclick="toggleSppGrade('hommes')" 
                            class="w-full flex items-center justify-between p-1.5 rounded mb-1 transition-all hover:scale-[1.02]"
                            style="background: ${config.background_color}; color: ${config.text_color};">
                      <span style="font-size: ${fontSize * 0.4}px; font-weight: 600;">Hommes du Rang</span>
                      <span id="spp-hommes-arrow" style="font-size: ${fontSize * 0.5}px; transition: transform 0.3s; transform: ${sppGradeStates['hommes'] ? 'rotate(180deg)' : 'rotate(0deg)'};">‚ñº</span>
                    </button>
                    <div id="spp-hommes" class="space-y-1" style="display: ${sppGradeStates['hommes'] ? 'block' : 'none'};">
                      ${availablePersonnel.filter(p => p.type === 'SPP' && !p.grade.toLowerCase().includes('sergent') && !p.grade.toLowerCase().includes('s/c') && !p.grade.toLowerCase().includes('a/c') && !p.grade.toLowerCase().includes('adjudant') && !assignedPersonnel.has(normName(p.name))
).map(person => `
                        <div draggable="true" 
                             ondragstart="handleDragStart(event, '${person.name}', '${person.grade}')"
                             class="personnel-card rounded-lg p-1.5 cursor-move group relative"
                             style="background: ${config.background_color}; border-left: 3px solid ${config.primary_action_color};">
                          <p style="font-size: ${fontSize * 0.42}px; color: ${config.text_color}; font-weight: 600;">${person.grade} ${person.name}</p>
                          <button onclick="event.stopPropagation(); deletePersonnel('${person.name}')" 
                                  class="opacity-0 group-hover:opacity-100 transition-opacity absolute top-1 right-1 rounded-full w-4 h-4 flex items-center justify-center hover:scale-110"
                                  style="background: ${config.primary_action_color}; color: ${config.text_color};">
                            <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                          </button>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <button onclick="toggleSpvMenu()" 
                        class="w-full flex items-center justify-between p-2 rounded-lg mb-2 transition-all hover:scale-[1.02]"
                        style="background: ${config.secondary_action_color}; color: ${config.background_color};">
                  <span style="font-size: ${fontSize * 0.5}px; font-weight: 700;">SPV</span>
                  <span id="spv-arrow" style="font-size: ${fontSize * 0.6}px; transition: transform 0.3s; transform: ${spvMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)'};">‚ñº</span>
                </button>
                <div id="spv-menu" class="space-y-3" style="display: ${spvMenuOpen ? 'block' : 'none'};">
                  ${[1, 2, 3, 4, 'Externe'].map(equipe => {
                    const equipeColors = {
                      '1': '#3b82f6',
                      '2': '#10b981',
                      '3': '#f59e0b',
                      '4': '#8b5cf6',
                      'Externe': '#6b7280'
                    };
                    const equipeColor = equipeColors[String(equipe)];
                    const equipeCount = availablePersonnel.filter(p => p.type === 'SPV' && p.equipe === String(equipe) && !assignedPersonnel.has(normName(p.name))
).length;
                    return `
                    <div>
                      <button onclick="toggleSpvEquipe('${equipe}')" 
                              class="w-full flex items-center justify-between p-1.5 rounded mb-1 transition-all hover:scale-[1.02]"
                              style="background: ${equipeColor}; color: ${config.text_color};">
                        <span style="font-size: ${fontSize * 0.4}px; font-weight: 600;">${equipe === 'Externe' ? 'Externe' : 'Equipe ' + equipe} (${equipeCount})</span>
                        <span id="spv-equipe${equipe}-arrow" style="font-size: ${fontSize * 0.5}px; transition: transform 0.3s; transform: ${spvEquipeStates[String(equipe)] ? 'rotate(180deg)' : 'rotate(0deg)'};">‚ñº</span>
                      </button>
                      <div id="spv-equipe${equipe}" class="space-y-1" style="display: ${spvEquipeStates[String(equipe)] ? 'block' : 'none'};">
                        ${availablePersonnel.filter(p => p.type === 'SPV' && p.equipe === String(equipe) && !assignedPersonnel.has(normName(p.name))
).map(person => `
                          <div draggable="true" 
                               ondragstart="handleDragStart(event, '${person.name}', '${person.grade}')"
                               class="personnel-card rounded-lg p-1.5 cursor-move group relative"
                               style="background: ${config.background_color}; border-left: 3px solid ${equipeColor};">
                            <p style="font-size: ${fontSize * 0.42}px; color: ${config.text_color}; font-weight: 600;">${person.grade} ${person.name}</p>
                            <button onclick="event.stopPropagation(); deletePersonnel('${person.name}')" 
                                    class="opacity-0 group-hover:opacity-100 transition-opacity absolute top-1 right-1 rounded-full w-4 h-4 flex items-center justify-center hover:scale-110"
                                    style="background: ${config.primary_action_color}; color: ${config.text_color};">
                              <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                            </button>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  `;
                  }).join('')}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    let sppMenuOpen = true;
    let spvMenuOpen = true;
    let sppGradeStates = { sousofficiers: false, hommes: false };
    let spvEquipeStates = { '1': false, '2': false, '3': false, '4': false, 'Externe': false };

    window.toggleSppMenu = function() {
      sppMenuOpen = !sppMenuOpen;
      render();
    };

    window.toggleSpvMenu = function() {
      spvMenuOpen = !spvMenuOpen;
      render();
    };

    window.toggleSppGrade = function(grade) {
      sppGradeStates[grade] = !sppGradeStates[grade];
      render();
    };

    window.toggleSpvEquipe = function(equipe) {
      spvEquipeStates[equipe] = !spvEquipeStates[equipe];
      render();
    };

    window.selectDayOfWeek = function(day) {
      selectedDayOfWeek = day;
      loadDataFromRecords(currentRecords);
      render();
    };

    window.handleDragStart = function(event, name, grade) {
      event.dataTransfer.setData('name', name);
      event.dataTransfer.setData('grade', grade);
    };

    window.removeSousOfficier = async function(nom) {
  const wk = weekKeyToMonday(getWeekKey(currentWeekOffset));
  const dow = Number(selectedDayOfWeek);

  const record = currentRecords.find(r =>
    r && r.type === 'sous_officier' &&
    sameName(r.nom, nom) &&
    Number(r.dayOfWeek) === dow &&
    weekKeyToMonday(r.weekKey) === wk
  );

  if (!record) {
    showSavingIndicator('‚úó Sous-officier introuvable', true);
    return;
  }
  await deleteData(record);
};

    window.removeEffectif = async function(nom) {
  const wk = weekKeyToMonday(getWeekKey(currentWeekOffset));
  const dow = Number(selectedDayOfWeek);

  // Si plusieurs lignes existent (ex: doublons), on supprime la plus r√©cente
  const candidates = currentRecords.filter(r =>
    r && r.type === 'effectif' &&
    sameName(r.nom, nom) &&
    Number(r.dayOfWeek) === dow &&
    weekKeyToMonday(r.weekKey) === wk
  );

  if (!candidates.length) {
    console.warn('removeEffectif: record introuvable', { nom, dow, wk, sample: currentRecords.slice(0, 3) });
    showSavingIndicator('‚úó Effectif introuvable (v√©rifie la semaine)', true);
    return;
  }

  // Priorit√© √† une ligne avec __backendId (obligatoire pour delete Apps Script)
  const record = candidates.slice().reverse().find(r => r.__backendId != null) || candidates[candidates.length - 1];
  await deleteData(record);
};

    window.removeDepart = async function(nom) {
  const wk = weekKeyToMonday(getWeekKey(currentWeekOffset));
  const dow = Number(selectedDayOfWeek);

  const record = currentRecords.find(r =>
    r && r.type === 'depart' &&
    sameName(r.nom, nom) &&
    Number(r.dayOfWeek) === dow &&
    weekKeyToMonday(r.weekKey) === wk
  );

  if (!record) {
    showSavingIndicator('‚úó D√©part introuvable', true);
    return;
  }
  await deleteData(record);
};

    window.addNewPersonnel = function() {
      const modalHTML = `
        <div id="personnel-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.7);">
          <div class="rounded-xl p-6" style="background: ${config.surface_color}; width: 400px; max-width: 90%; border: 2px solid ${config.secondary_action_color};">
            <h3 class="font-display mb-4" style="font-size: ${config.font_size * 0.8}px; color: ${config.text_color};">Ajouter un Sapeur</h3>
            
            <div class="space-y-3">
              <div>
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Nom :</label>
                <input type="text" id="new-personnel-nom" placeholder="Ex: DUPONT" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
              </div>
              
              <div>
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Grade :</label>
                <input type="text" id="new-personnel-grade" placeholder="Ex: Caporal, Sergent..." class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
              </div>
              
              <div>
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Type :</label>
                <select id="new-personnel-type" onchange="toggleEquipeField()" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color};">
                  <option value="SPP">SPP</option>
                  <option value="SPV">SPV</option>
                </select>
              </div>
              
              <div id="equipe-field">
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">√âquipe :</label>
                <select id="new-personnel-equipe" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color};">
                  <option value="1">√âquipe 1</option>
                  <option value="2">√âquipe 2</option>
                  <option value="3">√âquipe 3</option>
                  <option value="4">√âquipe 4</option>
                  <option value="Externe">Externe</option>
                </select>
              </div>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button onclick="confirmAddPersonnel(event)" data-confirm-personnel="1" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${config.font_size * 0.5}px;">
                Ajouter
              </button>
              <button onclick="closePersonnelModal()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${config.font_size * 0.5}px;">
                Annuler
              </button>
            </div>
          </div>
        </div>
      `;
      
      const modalDiv = document.createElement('div');
      modalDiv.innerHTML = modalHTML;
      document.body.appendChild(modalDiv.firstElementChild);
      
      toggleEquipeField();
    };
    
    window.toggleEquipeField = function() {
      const typeSelect = document.getElementById('new-personnel-type');
      const equipeField = document.getElementById('equipe-field');
      if (typeSelect && equipeField) {
        equipeField.style.display = typeSelect.value === 'SPV' ? 'block' : 'none';
      }
    };
    
    window.confirmAddPersonnel = async function(event) {
      const nom = document.getElementById('new-personnel-nom').value.trim();
      const grade = document.getElementById('new-personnel-grade').value.trim();
      const type = document.getElementById('new-personnel-type').value;
      const equipe = type === 'SPV' ? document.getElementById('new-personnel-equipe').value : null;
      
      if (!nom || !grade) {
        showSavingIndicator('‚úó Veuillez remplir tous les champs', true);
        return;
      }
      
      const confirmBtn = (event && event.target) ? event.target : document.querySelector('#personnel-modal button[data-confirm-personnel]');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Enregistrement...';
      }

      availablePersonnel.push({
        grade: grade,
        name: nom,
        type: type,
        equipe: equipe
      });
      
      await saveData('personnel', { nom, grade, personType: type, equipe });
      
      closePersonnelModal();
      render();
    };
    
    window.closePersonnelModal = function() {
      const modal = document.getElementById('personnel-modal');
      if (modal) {
        modal.remove();
      }
    };

    window.deletePersonnel = async function(nom) {
  const record = currentRecords.find(r => r && r.type === 'personnel' && sameName(r.nom, nom));
  if (!record) {
    showSavingIndicator('‚úó Personnel introuvable', true);
    return;
  }
  await deleteData(record);
};

    window.toggleInfirmierSelect = function() {
      const container = document.getElementById('infirmier-select-container');
      if (container) {
        container.classList.toggle('hidden');
      }
    };

    window.addInfirmierFromList = function(nom) {
      if (!nom) return;
      if (infirmiersGarde.some(inf => inf.nom === nom)) {
        return;
      }
      saveData('infirmier', { nom, creneau: '08h00 - 20h00' });
    };

    window.removeInfirmier = async function(nom) {
  const wk = weekKeyToMonday(getWeekKey(currentWeekOffset));
  const dow = Number(selectedDayOfWeek);

  const candidates = currentRecords.filter(r =>
    r && r.type === 'infirmier' &&
    sameName(r.nom, nom) &&
    Number(r.dayOfWeek) === dow &&
    weekKeyToMonday(r.weekKey) === wk
  );

  if (!candidates.length) {
    showSavingIndicator('‚úó Infirmier introuvable', true);
    return;
  }

  const record = candidates.slice().reverse().find(r => r.__backendId != null) || candidates[candidates.length - 1];
  await deleteData(record);
};

    window.updateInfirmierCreneau = function(nom, creneau) {
      const wk = weekKeyToMonday(getWeekKey(currentWeekOffset));
const dow = Number(selectedDayOfWeek);

const record = currentRecords.find(r =>
  r.type === 'infirmier' &&
  r.nom === nom &&
  Number(r.dayOfWeek) === dow &&
  (weekKeyToMonday(r.weekKey) || wk) === wk
);

      if (record) {
        record.creneau = creneau;
        if (saveTimeouts[record.__backendId]) {
          clearTimeout(saveTimeouts[record.__backendId]);
        }
        saveTimeouts[record.__backendId] = setTimeout(() => {
          updateData(record);
        }, 1000);
      }
    };

    window.updateApprenantNom = function(value) {
      window.apprenantNom = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'apprenantNom' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['apprenantNom']) clearTimeout(saveTimeouts['apprenantNom']);
        saveTimeouts['apprenantNom'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['apprenantNom']) clearTimeout(saveTimeouts['apprenantNom']);
        saveTimeouts['apprenantNom'] = setTimeout(() => saveData('notes', { zone: 'apprenantNom', notes: value }), 1000);
      }
    };

    window.updateApprenantCreneau = function(value) {
      window.apprenantCreneau = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'apprenantCreneau' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['apprenantCreneau']) clearTimeout(saveTimeouts['apprenantCreneau']);
        saveTimeouts['apprenantCreneau'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['apprenantCreneau']) clearTimeout(saveTimeouts['apprenantCreneau']);
        saveTimeouts['apprenantCreneau'] = setTimeout(() => saveData('notes', { zone: 'apprenantCreneau', notes: value }), 1000);
      }
    };

    function setupDragAndDrop() {
      document.querySelectorAll('.drop-zone-garde').forEach(zone => {
        zone.addEventListener('dragover', (e) => {
          e.preventDefault();
          zone.style.background = config.primary_action_color + '30';
        });

        zone.addEventListener('dragleave', (e) => {
          zone.style.background = config.surface_color;
        });

        zone.addEventListener('drop', async (e) => {
          e.preventDefault();
          zone.style.background = config.surface_color;
          
          const name = (e.dataTransfer.getData('name') || '').trim();
          const grade = e.dataTransfer.getData('grade');
          const zoneType = zone.dataset.zone;

          if (zoneType === 'sous_officier') {
            if (sousOfficierGarde.length >= 1) return;
            await saveData('sous_officier', { nom: name, grade });
          } else if (zoneType === 'effectif') {
            if (effectifGarde.length >= 10) return;
            const isSupplementaire = effectifGarde.length >= 5;
            let creneau = '';
            if (isSupplementaire) {
              const modalHTML = `
                <div id="creneau-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.7);">
                  <div class="rounded-xl p-6" style="background: ${config.surface_color}; width: 400px; max-width: 90%; border: 2px solid ${config.secondary_action_color};">
                    <h3 class="font-display mb-4" style="font-size: ${config.font_size * 0.8}px; color: ${config.text_color};">Cr√©neau Horaire</h3>
                    
                    <div class="mb-4">
                      <label class="block mb-2" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Saisissez le cr√©neau :</label>
                      <input type="text" id="creneau-input" placeholder="Ex: 08h00 - 14h00" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
                    </div>
                    
                    <div class="flex gap-2">
                      <button id="confirm-creneau-btn" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${config.font_size * 0.5}px;">
                        Valider
                      </button>
                      <button id="cancel-creneau-btn" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${config.font_size * 0.5}px;">
                        Annuler
                      </button>
                    </div>
                  </div>
                </div>
              `;
              
              const modalDiv = document.createElement('div');
              modalDiv.innerHTML = modalHTML;
              document.body.appendChild(modalDiv.firstElementChild);
              
              const creneauInput = document.getElementById('creneau-input');
              const confirmBtn = document.getElementById('confirm-creneau-btn');
              const cancelBtn = document.getElementById('cancel-creneau-btn');
              const modal = document.getElementById('creneau-modal');
              
              creneauInput.focus();
              
              await new Promise((resolve) => {
                confirmBtn.onclick = async () => {
                  creneau = creneauInput.value.trim();
                  modal.remove();
                  await saveData('effectif', { nom: name, grade, creneau, isSupplementaire });
                  resolve();
                };
                
                cancelBtn.onclick = () => {
                  modal.remove();
                  resolve();
                };
                
                creneauInput.onkeydown = (e) => {
                  if (e.key === 'Enter') {
                    confirmBtn.click();
                  } else if (e.key === 'Escape') {
                    cancelBtn.click();
                  }
                };
              });
            } else {
              await saveData('effectif', { nom: name, grade, creneau, isSupplementaire });
            }
          } else if (zoneType === 'depart') {
            if (prochainDepart.length >= 3) return;
            await saveData('depart', { nom: name, grade });
          }
        });
      });
    }

    function renderCalendarHeader() {
      const fontSize = config.font_size;
      const joursSemaine = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
      
      return `
        <div class="mb-3">
          <div class="flex items-center justify-between mb-2 gap-2">
            <div class="flex items-center gap-2">
              <button onclick="previousWeek()" 
                      class="px-3 py-2 rounded-lg font-bold transition-all duration-300 hover:scale-110"
                      style="background: ${config.surface_color}; color: ${config.text_color}; font-size: ${fontSize * 0.45}px; border: 2px solid ${config.text_color}40;">
                ‚Üê Semaine
              </button>
              <button onclick="goToCurrentWeek()"
                      class="px-3 py-2 rounded-lg font-bold transition-all duration-300 hover:scale-110"
                      style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${fontSize * 0.45}px;">
                Aujourd'hui
              </button>
              <button onclick="nextWeek()"
                      class="px-3 py-2 rounded-lg font-bold transition-all duration-300 hover:scale-110"
                      style="background: ${config.surface_color}; color: ${config.text_color}; font-size: ${fontSize * 0.45}px; border: 2px solid ${config.text_color}40;">
                Semaine ‚Üí
              </button>
            </div>
            <button onclick="toggleCalendar()" 
                    class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 flex items-center gap-2"
                    style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${fontSize * 0.5}px;">
              üóìÔ∏è ${formatWeekRange(currentWeekOffset)}
              <span id="calendar-arrow" style="transition: transform 0.3s;">‚ñº</span>
            </button>
          </div>
          <div id="calendar-container" class="hidden mb-2 rounded-xl p-4" onclick="event.stopPropagation()" style="background: ${config.surface_color}; border: 2px solid ${config.secondary_action_color};">
            ${renderCalendar()}
          </div>
          
          <div class="flex gap-1">
            ${[1, 2, 3, 4, 5, 6, 0].map((index) => `
              <button onclick="selectDayOfWeek(${index})"
                      class="px-3 py-1.5 rounded-lg font-semibold transition-all duration-300 hover:scale-105 flex flex-col items-center"
                      style="background: ${selectedDayOfWeek === index ? config.primary_action_color : config.surface_color}; color: ${config.text_color}; font-size: ${fontSize * 0.5}px; border: 2px solid ${selectedDayOfWeek === index ? config.primary_action_color : config.text_color}40;">
                <span>${joursSemaine[index]}</span>
                <span style="font-size: ${fontSize * 0.38}px; opacity: 0.8;">
                  ${new Date(getSelectedDateForCurrentView().getTime() + (index - selectedDayOfWeek) * 86400000).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' })}
                </span>
              </button>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderVerificationsSlide() {
      const fontSize = config.font_size;
      
      const verificationsPlanningMap = {
        1: [
          { id: 'vsav1', nom: 'VSAV 1', icon: 'üö®' },
          { id: 'fpt55', nom: 'FPT 55', icon: 'üöí' },
          { id: 'lot_ps_sap', nom: 'Lot PS SAP + R√©serve d\'approche + Portatifs', icon: 'üì¶' }
        ],
        2: [
          { id: 'vsav2', nom: 'VSAV 2', icon: 'üöë' },
          { id: 'mea', nom: 'MEA', icon: 'üö®' },
          { id: 'vsrm', nom: 'VSRM', icon: 'üöí' },
          { id: 'niveaux_vl', nom: 'Niveaux et inventaires des VL', icon: '‚õΩ' }
        ],
        3: [
          { id: 'vsav1', nom: 'VSAV 1', icon: 'üöë' },
          { id: 'vtu', nom: 'VTU + Lot OPDI', icon: 'üöô' },
          { id: 'embarcation', nom: 'Embarcation + MPR', icon: '‚õµ' },
          { id: 'pl_niveaux', nom: 'PL niveaux et mise en route', icon: 'üöí' }
        ],
        4: [
          { id: 'vsav2', nom: 'VSAV 2', icon: 'üöë' },
          { id: 'mea', nom: 'MEA', icon: 'üö®' },
          { id: 'ccfm', nom: 'CCFM', icon: 'üöí' },
          { id: 'compresseur', nom: 'Pression compresseur + niveau karcher + jerricans', icon: 'üîß' }
        ],
        5: [
          { id: 'vsav1', nom: 'VSAV 1', icon: 'üöë' },
          { id: 'fpt53', nom: 'FPT 53', icon: 'üöí' },
          { id: 'lot_ps_sap', nom: 'Lot PS SAP / R√©serve d\'approche', icon: 'üì¶' },
          { id: 'novven', nom: 'Nettoyage des armoires Novven', icon: 'üßπ' }
        ],
        6: [
          { id: 'vsav2', nom: 'VSAV 2', icon: 'üöë' },
          { id: 'vsrm', nom: 'VSRM', icon: 'üöí' },
          { id: 'fpt55', nom: 'FPT 55', icon: 'üöí' },
          { id: 'portatifs', nom: 'V√©rifier la charge de l\'ensemble des portatifs (TTH 700 et 900)', icon: 'üìª' }
        ],
        0: [
          { id: 'vsav1', nom: 'VSAV 1', icon: 'üöë' },
          { id: 'mea', nom: 'MEA', icon: 'üö®' },
          { id: 'fpt53', nom: 'FPT 53', icon: 'üöí' },
          { id: 'carburants', nom: 'Pleins carburants des VL et PL', icon: '‚õΩ' }
        ]
      };
      
      const vehicules = verificationsPlanningMap[selectedDayOfWeek] || verificationsPlanningMap[1];

      const personnelGarde = [...sousOfficierGarde, ...effectifGarde].map(p => ({
        nom: p.nom,
        grade: p.grade
      }));

      return `
        <div class="h-full flex gap-4">
          <div class="flex-1 flex flex-col">
            ${renderCalendarHeader()}
            <h2 class="font-display tracking-wider mb-4" style="font-size: ${fontSize * 1.5}px; color: ${config.text_color};">V√âRIFICATIONS DU JOUR</h2>
            
            <div class="grid ${vehicules.length > 4 ? 'grid-cols-3' : 'grid-cols-2'} gap-4 flex-1 overflow-auto">
              ${vehicules.map(v => `
              <div class="rounded-xl p-4 drop-zone" data-zone="${v.id}" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
                <div class="flex items-center gap-3 mb-3">
                  <span style="font-size: ${fontSize * 1.2}px;">${v.icon}</span>
                  <p class="font-display tracking-wider" style="font-size: ${fontSize * 0.65}px; color: ${config.secondary_action_color}; line-height: 1.2;">${v.nom}</p>
                </div>
                <div id="verif-${v.id}" class="space-y-2">
                  ${(vehiculeAssignments[v.id] || []).map(nom => `
                    <div class="rounded-lg p-2 group flex items-center justify-between" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                      <p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}; font-weight: 600;">${nom}</p>
                      <button onclick="removeVerification('${v.id}', '${nom}')" 
                              class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-5 h-5 flex items-center justify-center hover:scale-110"
                              style="background: ${config.primary_action_color}; color: ${config.text_color};">
                        <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                      </button>
                    </div>
                  `).join('') || `<p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}40; text-align: center; padding: 12px;">Glissez un sapeur ici (max 2)</p>`}
                </div>
              </div>
            `).join('')}
            </div>
          </div>
          
          <div class="w-64 rounded-xl p-4 flex flex-col overflow-auto" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color};">
            <h3 class="font-display tracking-wider mb-3" style="font-size: ${fontSize * 0.8}px; color: ${config.text_color};">Personnel de Garde</h3>
            <div class="space-y-2">
              ${personnelGarde.length > 0 ? personnelGarde.map(person => `
                <div draggable="true" 
                     ondragstart="handleDragStart(event, '${person.nom}', '${person.grade}')"
                     class="rounded-lg p-2 cursor-move"
                     style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                  <p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}; font-weight: 600;">${person.grade} ${person.nom}</p>
                </div>
              `).join('') : `<p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}60; text-align: center; padding: 8px;">Aucun personnel de garde</p>`}
            </div>
          </div>
        </div>
      `;
    }

    window.removeVerification = async function(vehiculeId, nom) {
  const wk = weekKeyToMonday(getWeekKey(currentWeekOffset));
  const dow = Number(selectedDayOfWeek);

  const candidates = currentRecords.filter(r =>
    r && r.type === 'verification' &&
    r.zone === vehiculeId &&
    sameName(r.nom, nom) &&
    Number(r.dayOfWeek) === dow &&
    weekKeyToMonday(r.weekKey) === wk
  );

  if (!candidates.length) {
    showSavingIndicator('‚úó V√©rification introuvable', true);
    return;
  }

  const record = candidates.slice().reverse().find(r => r.__backendId != null) || candidates[candidates.length - 1];
  await deleteData(record);
};

    function setupVerificationsDragAndDrop() {
      document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dragover', (e) => {
          e.preventDefault();
          zone.style.background = config.primary_action_color + '30';
        });

        zone.addEventListener('dragleave', (e) => {
          zone.style.background = config.surface_color;
        });

        zone.addEventListener('drop', async (e) => {
  e.preventDefault();
  zone.style.background = config.surface_color;

  const name = (e.dataTransfer.getData('name') || '').trim();
  const grade = e.dataTransfer.getData('grade') || '';
  const vehiculeId = zone.dataset.zone;

  if (!name) return;

  if (!vehiculeAssignments[vehiculeId]) vehiculeAssignments[vehiculeId] = [];
  if (vehiculeAssignments[vehiculeId].length >= 2) return;
  if (vehiculeAssignments[vehiculeId].includes(name)) return;

  await saveData('verification', { nom: name, grade, zone: vehiculeId });
});
        });
    }

    function renderActiviteSlide() {
      const fontSize = config.font_size;

      // Activit√©s par d√©faut par jour
      const activitesParDefaut = {
        1: { type: 'Course √† pied fondamentale', creneau: '8h30 - 10h00' },
        2: { type: 'Renforcement musculaire', creneau: '8h30 - 10h00' },
        3: { type: 'Natation', creneau: '7h00 - 8h00' },
        4: { type: 'Course √† pied sp√©cifique', creneau: '8h30 - 10h00' },
        5: { type: 'Sport collectif', creneau: '8h30 - 10h00' },
        6: { type: 'Autre', creneau: '8h30 - 10h00' }
      };

      const activiteActuelle = activitesParDefaut[selectedDayOfWeek] || { type: '', creneau: '' };
      const typeActuel = window.activitePhysiqueType || activiteActuelle.type;
      const creneauActuel = window.activitePhysiqueCreneau || activiteActuelle.creneau;

      return `
        <div class="h-full flex flex-col">
          ${renderCalendarHeader()}
          <h2 class="font-display tracking-wider mb-4" style="font-size: ${fontSize * 1.5}px; color: ${config.text_color};">ACTIVIT√âS DE LA GARDE</h2>
          
          <div class="grid grid-cols-2 gap-4 flex-1">
            <div class="rounded-xl p-4" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color};">
              <h3 class="font-display tracking-wider mb-3 flex items-center gap-2" style="font-size: ${fontSize * 0.8}px; color: ${config.primary_action_color};">
                üí™ ACTIVIT√â PHYSIQUE
                <button onclick="modifierActivitePhysique()" 
                        class="rounded-lg px-3 py-1 transition-all duration-300 hover:scale-105 flex items-center gap-1"
                        style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${fontSize * 0.4}px;">
                  ‚úèÔ∏è Modifier
                </button>
              </h3>
              
              <div class="rounded-lg p-4" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                <p style="font-size: ${fontSize * 0.6}px; color: ${config.text_color}; font-weight: 700; margin-bottom: 8px;">${typeActuel}</p>
                <p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}80;">‚è∞ ${creneauActuel}</p>
              </div>
            </div>

            <div class="rounded-xl p-4 flex-1" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color};">
              <h3 class="font-display tracking-wider mb-3" style="font-size: ${fontSize * 0.8}px; color: ${config.primary_action_color};">üî• MAN≈íUVRE DE LA GARDE</h3>
              
              <textarea id="manoeuvre-garde-textarea"
                        onchange="updateManoeuvreGarde(this.value)"
                        placeholder="Description de la man≈ìuvre du jour..."
                        class="w-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 resize-none h-full"
                        style="background: ${config.background_color}; font-size: ${fontSize * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40; min-height: 200px;">${window.manoeuvreGarde || ''}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    window.modifierActivitePhysique = function() {
      const activitesParDefaut = {
        1: { type: 'Course √† pied fondamentale', creneau: '8h30 - 10h00' },
        2: { type: 'Renforcement musculaire', creneau: '8h30 - 10h00' },
        3: { type: 'Natation', creneau: '7h00 - 8h00' },
        4: { type: 'Course √† pied sp√©cifique', creneau: '8h30 - 10h00' },
        5: { type: 'Sport collectif', creneau: '8h30 - 10h00' },
        6: { type: 'Autre', creneau: '8h30 - 10h00' }
      };

      const activiteActuelle = activitesParDefaut[selectedDayOfWeek] || { type: '', creneau: '' };
      const typeActuel = window.activitePhysiqueType || activiteActuelle.type;
      const creneauActuel = window.activitePhysiqueCreneau || activiteActuelle.creneau;

      const modalHTML = `
        <div id="activite-physique-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.7);">
          <div class="rounded-xl p-6" style="background: ${config.surface_color}; width: 450px; max-width: 90%; border: 2px solid ${config.secondary_action_color};">
            <h3 class="font-display mb-4" style="font-size: ${config.font_size * 0.8}px; color: ${config.text_color};">Modifier l'Activit√© Physique</h3>
            
            <div class="space-y-3">
              <div>
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Type d'activit√© :</label>
                <select id="activite-type-select" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color};">
                  <option value="Course √† pied fondamentale" ${typeActuel === 'Course √† pied fondamentale' ? 'selected' : ''}>Course √† pied fondamentale</option>
                  <option value="Renforcement musculaire" ${typeActuel === 'Renforcement musculaire' ? 'selected' : ''}>Renforcement musculaire</option>
                  <option value="Natation" ${typeActuel === 'Natation' ? 'selected' : ''}>Natation</option>
                  <option value="Course √† pied sp√©cifique" ${typeActuel === 'Course √† pied sp√©cifique' ? 'selected' : ''}>Course √† pied sp√©cifique</option>
                  <option value="Sport collectif" ${typeActuel === 'Sport collectif' ? 'selected' : ''}>Sport collectif</option>
                  <option value="Autre" ${typeActuel === 'Autre' ? 'selected' : ''}>Autre</option>
                </select>
              </div>
              
              <div>
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Cr√©neau horaire :</label>
                <input type="text" 
                       id="activite-creneau-input" 
                       value="${creneauActuel}"
                       placeholder="Ex: 8h30 - 10h00"
                       class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2"
                       style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
              </div>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button onclick="confirmerActivitePhysique()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${config.font_size * 0.5}px;">
                Valider
              </button>
              <button onclick="fermerActivitePhysiqueModal()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${config.font_size * 0.5}px;">
                Annuler
              </button>
            </div>
          </div>
        </div>
      `;
      
      const modalDiv = document.createElement('div');
      modalDiv.innerHTML = modalHTML;
      document.body.appendChild(modalDiv.firstElementChild);
    };

    window.confirmerActivitePhysique = function() {
      const type = document.getElementById('activite-type-select').value;
      const creneau = document.getElementById('activite-creneau-input').value.trim();
      
      updateActivitePhysiqueType(type);
      updateActivitePhysiqueCreneau(creneau);
      
      fermerActivitePhysiqueModal();
      setTimeout(() => render(), 100);
    };

    window.fermerActivitePhysiqueModal = function() {
      const modal = document.getElementById('activite-physique-modal');
      if (modal) modal.remove();
    };

    window.toggleTigItem = function(index, checked) {
      if (!window.tigChecked) window.tigChecked = {};
      window.tigChecked[index] = checked;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'tigChecked' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = JSON.stringify(window.tigChecked);
        updateData(existingRecord);
      } else {
        saveData('notes', { zone: 'tigChecked', notes: JSON.stringify(window.tigChecked) });
      }
    };

    window.updateTigDivers = function(value) {
      window.tigDivers = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'tigDivers' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['tigDivers']) clearTimeout(saveTimeouts['tigDivers']);
        saveTimeouts['tigDivers'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['tigDivers']) clearTimeout(saveTimeouts['tigDivers']);
        saveTimeouts['tigDivers'] = setTimeout(() => saveData('notes', { zone: 'tigDivers', notes: value }), 1000);
      }
    };

    window.updateActivitePhysiqueType = function(value) {
      window.activitePhysiqueType = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'activitePhysiqueType' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['activitePhysiqueType']) clearTimeout(saveTimeouts['activitePhysiqueType']);
        saveTimeouts['activitePhysiqueType'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['activitePhysiqueType']) clearTimeout(saveTimeouts['activitePhysiqueType']);
        saveTimeouts['activitePhysiqueType'] = setTimeout(() => saveData('notes', { zone: 'activitePhysiqueType', notes: value }), 1000);
      }
    };

    window.updateActivitePhysiqueCreneau = function(value) {
      window.activitePhysiqueCreneau = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'activitePhysiqueCreneau' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['activitePhysiqueCreneau']) clearTimeout(saveTimeouts['activitePhysiqueCreneau']);
        saveTimeouts['activitePhysiqueCreneau'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['activitePhysiqueCreneau']) clearTimeout(saveTimeouts['activitePhysiqueCreneau']);
        saveTimeouts['activitePhysiqueCreneau'] = setTimeout(() => saveData('notes', { zone: 'activitePhysiqueCreneau', notes: value }), 1000);
      }
    };

    window.updateManoeuvreGarde = function(value) {
      window.manoeuvreGarde = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'manoeuvreGarde' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['manoeuvreGarde']) clearTimeout(saveTimeouts['manoeuvreGarde']);
        saveTimeouts['manoeuvreGarde'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['manoeuvreGarde']) clearTimeout(saveTimeouts['manoeuvreGarde']);
        saveTimeouts['manoeuvreGarde'] = setTimeout(() => saveData('notes', { zone: 'manoeuvreGarde', notes: value }), 1000);
      }
    };

    function renderGproSlide() {
      const fontSize = config.font_size;
      
      const allTigGproItems = [
        { jour: 'Lundi', jours: [1], texte: 'Commande O¬≤' },

        // ‚úÖ Mensuel (1er lundi du mois)
        { jour: 'Lundi', jours: [1], texte: '8h00 - 9h00 : GROUPE ELECTROGENE - essai pendant 1 heure', monthlyFirstMonday: true },

        { jour: 'Mercredi', jours: [3], texte: '14h00 - Sortir Poubelles Grises et Jaunes' },
        { jour: 'Mercredi', jours: [3], texte: 'D√©sinfection VSAV (voir roulement sur la feuille de suivi)' },

        { jour: 'Jeudi', jours: [4], texte: '14h00 - Mettre les "SpiraLED" en charge des FPT et VSR' },

        // ‚úÖ Tous les 15 jours (semaines paires)
        { jour: 'Jeudi', jours: [4], texte: 'Inventaire : Equipements de Protection Collective (EPC)', everyOtherWeekEven: true },

        { jour: 'Vendredi', jours: [5], texte: 'TIG', isTIG: true, tigItems: [
          'Vider les cendriers',
          'Sanitaires H et F',
          'Remise PL',
          'Remise VSAV',
          'Vestiaires H et F',
          'Foyer et salle de sport',
          'Divers'
        ] },
        { jour: 'Samedi & Dimanche', jours: [6, 0], texte: 'LOGEMENT DE GARDE : Nettoyage + rangement des effets personnels et les enlever apr√®s la garde ou astreinte + HOUSSES ET TAIES : laver, s√©cher et les reconditionner dans les housses sous blisters individuels. V√©rification par responsable de la garde.' },
        { jour: 'Dimanche', jours: [0], texte: 'Vider les armoires NOVVEN et D√©sinfection du VSAV' }
      ];

      const selectedDate = getSelectedDateForCurrentView();
      const selectedWeekNo = getISOWeekNumber(selectedDate);

      const tigGproItems = allTigGproItems.filter(item => {
        if (!item.jours.includes(selectedDayOfWeek)) return false;

        // tous les 15 jours, semaines paires
        if (item.everyOtherWeekEven && (selectedWeekNo % 2 !== 0)) return false;

        // mensuel : 1er lundi du mois
        if (item.monthlyFirstMonday) {
          const isMonday = selectedDate.getDay() === 1;
          const isFirstMonday = selectedDate.getDate() <= 7;
          if (!isMonday || !isFirstMonday) return false;
        }

        return true;
      });

      return `
        <div class="h-full flex flex-col">
          ${renderCalendarHeader()}
          <h2 class="font-display tracking-wider mb-4" style="font-size: ${fontSize * 1.5}px; color: ${config.text_color};">CASERNEMENT</h2>
          
          <div class="grid grid-cols-2 gap-4 flex-1">
            <div class="rounded-xl p-4 flex flex-col" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
              <h3 class="font-display tracking-wider mb-3" style="font-size: ${fontSize * 0.8}px; color: ${config.secondary_action_color};">üìÖ INFORMATIONS HEBDOMADAIRES</h3>
              
              <div class="space-y-2 flex-1 overflow-auto pr-2" style="max-height: 400px;">
                ${tigGproItems.map((item, i) => {
                  if (item.isTIG) {
                    // Pour le TIG du vendredi - afficher la liste compl√®te
                    return `
                      <div class="p-3 rounded-lg" style="background: ${config.background_color}; border-left: 4px solid ${config.secondary_action_color};">
                        <p style="font-size: ${fontSize * 0.5}px; color: ${config.secondary_action_color}; font-weight: 700; margin-bottom: 8px;">${item.jour} : ${item.texte}</p>
                        <div class="space-y-2">
                          ${item.tigItems.map((tigItem, tigIndex) => {
                            const checked = window.tigVendrediChecked && window.tigVendrediChecked[tigIndex] ? 'checked' : '';
                            return `
                              <div class="flex items-start gap-2">
                                <input type="checkbox" 
                                       id="tig-vendredi-${tigIndex}" 
                                       ${checked}
                                       onchange="toggleTigVendrediItem(${tigIndex}, this.checked)"
                                       class="mt-1 cursor-pointer flex-shrink-0" 
                                       style="width: 16px; height: 16px; accent-color: ${config.secondary_action_color};">
                                <label for="tig-vendredi-${tigIndex}" class="flex-1 cursor-pointer" style="font-size: ${fontSize * 0.42}px; color: ${config.text_color};">
                                  ${tigItem}
                                </label>
                              </div>
                            `;
                          }).join('')}
                        </div>
                        <div class="mt-2">
                          <textarea id="tig-vendredi-divers-textarea"
                                    onchange="updateTigVendrediDivers(this.value)"
                                    placeholder="D√©tails suppl√©mentaires pour Divers..."
                                    class="w-full rounded px-2 py-1 focus:outline-none focus:ring-2 resize-none"
                                    rows="2"
                                    style="background: ${config.surface_color}; font-size: ${fontSize * 0.4}px; color: ${config.text_color}; border: 1px solid ${config.secondary_action_color}40;">${window.tigVendrediDivers || ''}</textarea>
                        </div>
                      </div>
                    `;
                  } else {
                    // Pour les autres items
                    return `
                      <div class="flex items-start gap-2 p-3 rounded-lg hover:scale-[1.01] transition-all" style="background: ${config.background_color}; border-left: 4px solid ${config.secondary_action_color};">
                        <input type="checkbox" 
                               id="tig-gpro-${i}" 
                               ${window.tigGproChecked && window.tigGproChecked[i] ? 'checked' : ''}
                               onchange="toggleTigGproItem(${i}, this.checked)"
                               class="mt-1 cursor-pointer flex-shrink-0" 
                               style="width: 18px; height: 18px; accent-color: ${config.secondary_action_color};">
                        <label for="tig-gpro-${i}" class="flex-1 cursor-pointer" style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}; line-height: 1.5;">
                          <span style="font-weight: 700; color: ${config.secondary_action_color};">${item.jour} :</span> ${item.texte}
                        </label>
                      </div>
                    `;
                  }
                }).join('')}
              </div>
              
              <div class="mt-3">
                <p class="mb-2" style="font-size: ${fontSize * 0.5}px; color: ${config.secondary_action_color}; font-weight: 600;">Notes diverses :</p>
                <textarea id="tig-gpro-divers-textarea"
                          onchange="updateTigGproDivers(this.value)"
                          placeholder="Informations compl√©mentaires..."
                          class="w-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 resize-none"
                          rows="3"
                          style="background: ${config.background_color}; font-size: ${fontSize * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">${window.tigGproDivers || ''}</textarea>
              </div>
            </div>

            <div class="flex flex-col gap-4">
              <div class="rounded-xl p-4" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color};">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-display tracking-wider" style="font-size: ${fontSize * 0.7}px; color: ${config.primary_action_color};">üè¢ R√âSERVATION SALLE</h3>
                  <button onclick="addReservationSalle()" 
                          class="rounded-full w-6 h-6 flex items-center justify-center transition-all duration-300 hover:scale-110"
                          style="background: ${config.secondary_action_color}; color: ${config.background_color};">
                    <span style="font-size: ${fontSize * 0.7}px; font-weight: bold;">+</span>
                  </button>
                </div>

                ${Number(selectedDayOfWeek)===Number(getHarmonieReservationDay()) ? `
<div class="rounded-lg p-2 mb-2" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                  <div class="flex items-center justify-between gap-2">
                    <div class="flex-1">
                      <p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}; font-weight: 700;">R√©servation salle de cours pour r√©p√©tition Harmonie √† partir de 20h30</p>
                      <p style="font-size: ${fontSize * 0.4}px; color: ${config.text_color}70;">Affich√© automatiquement (modifiable)</p>
                    </div>
                    <select onchange="setHarmonieReservationDay(this.value)" class="rounded px-2 py-1 focus:outline-none"
                            style="background: ${config.surface_color}; font-size: ${fontSize * 0.4}px; color: ${config.text_color}; border: 1px solid ${config.secondary_action_color}40;">
                      ${[
                        {v:1,t:'Lun'}, {v:2,t:'Mar'}, {v:3,t:'Mer'}, {v:4,t:'Jeu'}, {v:5,t:'Ven'}, {v:6,t:'Sam'}, {v:0,t:'Dim'}
                      ].map(o => '<option value="' + o.v + '" ' + (Number(getHarmonieReservationDay())===o.v ? 'selected' : '') + '>' + o.t + '</option>').join('')}
                    </select>
                  </div>
                </div>
                ` : ``}
                <div class="space-y-2 overflow-auto" style="max-height: 300px;">
                  ${(window.reservationSalleList || []).map((item) => `
                    <div class="rounded-lg p-2 group" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                      <div class="flex items-start justify-between">
                        <div class="flex-1">
                          <p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color};">${item.texte}</p>
                          ${item.dateDebut || item.dateFin ? `
                            <p style="font-size: ${fontSize * 0.4}px; color: ${config.text_color}60; margin-top: 4px;">
                              ${item.dateDebut ? new Date(item.dateDebut).toLocaleDateString('fr-FR') : ''} 
                              ${item.dateDebut && item.dateFin ? '‚Üí' : ''} 
                              ${item.dateFin ? new Date(item.dateFin).toLocaleDateString('fr-FR') : ''}
                            </p>
                          ` : ''}
                        </div>
                        <button onclick="deleteReservationSalle('${item.__backendId}')" 
                                class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-5 h-5 flex items-center justify-center hover:scale-110"
                                style="background: ${config.primary_action_color}; color: ${config.text_color};">
                          <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                        </button>
                      </div>
                    </div>
                  `).join('') || `<p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}60; text-align: center; padding: 8px;">Aucune r√©servation</p>`}
                </div>
              </div>

              <div class="rounded-xl p-4 flex-1" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color};">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-display tracking-wider" style="font-size: ${fontSize * 0.7}px; color: ${config.primary_action_color};">üß∞ PR√âPARATION DU MAT√âRIEL R√âSERV√â POUR D√âPART NAVETTE</h3>
                  <button onclick="addDiversGpro()" 
                          class="rounded-full w-6 h-6 flex items-center justify-center transition-all duration-300 hover:scale-110"
                          style="background: ${config.secondary_action_color}; color: ${config.background_color};">
                    <span style="font-size: ${fontSize * 0.7}px; font-weight: bold;">+</span>
                  </button>
                </div>
                <div class="space-y-2 overflow-auto" style="max-height: 300px;">
                  ${(window.diversGproList || []).map((item) => `
                    <div class="rounded-lg p-2 group" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                      <div class="flex items-start justify-between">
                        <div class="flex-1">
                          <p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color};">${item.texte}</p>
                          ${item.dateDebut || item.dateFin ? `
                            <p style="font-size: ${fontSize * 0.4}px; color: ${config.text_color}60; margin-top: 4px;">
                              ${item.dateDebut ? new Date(item.dateDebut).toLocaleDateString('fr-FR') : ''} 
                              ${item.dateDebut && item.dateFin ? '‚Üí' : ''} 
                              ${item.dateFin ? new Date(item.dateFin).toLocaleDateString('fr-FR') : ''}
                            </p>
                          ` : ''}
                        </div>
                        <button onclick="deleteDiversGpro('${item.__backendId}')" 
                                class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-5 h-5 flex items-center justify-center hover:scale-110"
                                style="background: ${config.primary_action_color}; color: ${config.text_color};">
                          <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                        </button>
                      </div>
                    </div>
                  `).join('') || `<p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}60; text-align: center; padding: 8px;">Aucune information</p>`}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.toggleTigVendrediItem = function(index, checked) {
      if (!window.tigVendrediChecked) window.tigVendrediChecked = {};
      window.tigVendrediChecked[index] = checked;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'tigVendrediChecked' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = JSON.stringify(window.tigVendrediChecked);
        updateData(existingRecord);
      } else {
        saveData('notes', { zone: 'tigVendrediChecked', notes: JSON.stringify(window.tigVendrediChecked) });
      }
    };

    window.updateTigVendrediDivers = function(value) {
      window.tigVendrediDivers = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'tigVendrediDivers' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['tigVendrediDivers']) clearTimeout(saveTimeouts['tigVendrediDivers']);
        saveTimeouts['tigVendrediDivers'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['tigVendrediDivers']) clearTimeout(saveTimeouts['tigVendrediDivers']);
        saveTimeouts['tigVendrediDivers'] = setTimeout(() => saveData('notes', { zone: 'tigVendrediDivers', notes: value }), 1000);
      }
    };

    window.updateTigGproDivers = function(value) {
      window.tigGproDivers = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'tigGproDivers' && r.dayOfWeek === selectedDayOfWeek && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['tigGproDivers']) clearTimeout(saveTimeouts['tigGproDivers']);
        saveTimeouts['tigGproDivers'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['tigGproDivers']) clearTimeout(saveTimeouts['tigGproDivers']);
        saveTimeouts['tigGproDivers'] = setTimeout(() => saveData('notes', { zone: 'tigGproDivers', notes: value }), 1000);
      }
    };

    window.addReservationSalle = function() {
      const modalHTML = `
        <div id="reservation-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.7);">
          <div class="rounded-xl p-6" style="background: ${config.surface_color}; width: 450px; max-width: 90%; border: 2px solid ${config.secondary_action_color};">
            <h3 class="font-display mb-4" style="font-size: ${config.font_size * 0.8}px; color: ${config.text_color};">Nouvelle R√©servation</h3>
            
            <div class="space-y-3">
              <div>
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Description :</label>
                <textarea id="reservation-texte" 
                          placeholder="Ex: Formation PSE1 - Salle de cours"
                          class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2 resize-none"
                          rows="2"
                          style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;"></textarea>
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date d√©but :</label>
                  <input type="date" id="reservation-date-debut" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
                </div>
                <div>
                  <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date fin :</label>
                  <input type="date" id="reservation-date-fin" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
                </div>
              </div>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button onclick="confirmReservationSalle()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${config.font_size * 0.5}px;">
                Ajouter
              </button>
              <button onclick="closeReservationModal()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${config.font_size * 0.5}px;">
                Annuler
              </button>
            </div>
          </div>
        </div>
      `;
      
      const modalDiv = document.createElement('div');
      modalDiv.innerHTML = modalHTML;
      document.body.appendChild(modalDiv.firstElementChild);
    };

    window.confirmReservationSalle = async function() {
      const texte = document.getElementById('reservation-texte').value.trim();
      const dateDebut = document.getElementById('reservation-date-debut').value;
      const dateFin = document.getElementById('reservation-date-fin').value;
      
      if (!texte) {
        showSavingIndicator('‚úó Veuillez saisir une description', true);
        return;
      }
      
      await saveData('notes', { zone: 'reservationSalle', notes: texte, creneau: dateDebut, grade: dateFin });
      closeReservationModal();
    };

    window.closeReservationModal = function() {
      const modal = document.getElementById('reservation-modal');
      if (modal) modal.remove();
    };

    window.deleteReservationSalle = async function(backendId) {
      const bid = Number(backendId);
      const record = currentRecords.find(r => Number(r.__backendId) === bid);
      if (record) {
        await deleteData(record);
      }
    };

    window.addDiversGpro = function() {
      const modalHTML = `
        <div id="divers-gpro-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.7);">
          <div class="rounded-xl p-6" style="background: ${config.surface_color}; width: 450px; max-width: 90%; border: 2px solid ${config.secondary_action_color};">
            <h3 class="font-display mb-4" style="font-size: ${config.font_size * 0.8}px; color: ${config.text_color};">Nouvelle Information</h3>
            
            <div class="space-y-3">
              <div>
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Description :</label>
                <textarea id="divers-gpro-texte" 
                          placeholder="Ex: Travaux de peinture au 1er √©tage"
                          class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2 resize-none"
                          rows="2"
                          style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;"></textarea>
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date d√©but :</label>
                  <input type="date" id="divers-gpro-date-debut" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
                </div>
                <div>
                  <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date fin :</label>
                  <input type="date" id="divers-gpro-date-fin" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
                </div>
              </div>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button onclick="confirmDiversGpro()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${config.font_size * 0.5}px;">
                Ajouter
              </button>
              <button onclick="closeDiversGproModal()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${config.font_size * 0.5}px;">
                Annuler
              </button>
            </div>
          </div>
        </div>
      `;
      
      const modalDiv = document.createElement('div');
      modalDiv.innerHTML = modalHTML;
      document.body.appendChild(modalDiv.firstElementChild);
    };

    window.confirmDiversGpro = async function() {
      const texte = document.getElementById('divers-gpro-texte').value.trim();
      const dateDebut = document.getElementById('divers-gpro-date-debut').value;
      const dateFin = document.getElementById('divers-gpro-date-fin').value;
      
      if (!texte) {
        showSavingIndicator('‚úó Veuillez saisir une description', true);
        return;
      }
      
      await saveData('notes', { zone: 'diversGpro', notes: texte, creneau: dateDebut, grade: dateFin });
      closeDiversGproModal();
    };

    window.closeDiversGproModal = function() {
      const modal = document.getElementById('divers-gpro-modal');
      if (modal) modal.remove();
    };

    window.deleteDiversGpro = async function(backendId) {
      const bid = Number(backendId);
      const record = currentRecords.find(r => Number(r.__backendId) === bid);
      if (record) {
        await deleteData(record);
      }
    };

    function renderNouvelleSlide() {
      const fontSize = config.font_size;
      
      return `
        <div class="h-full flex flex-col">
          ${renderCalendarHeader()}
          <h2 class="font-display tracking-wider mb-4" style="font-size: ${fontSize * 1.5}px; color: ${config.text_color};">INFORMATIONS QUOTIDIENNES</h2>
          
          <div class="grid grid-cols-2 gap-4 flex-1">
            <div class="rounded-xl p-6" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
              <textarea id="nouvelle-notes-textarea"
                        onchange="updateNouvelleNotes(this.value)"
                        placeholder="Saisissez les informations importantes du jour..."
                        class="w-full h-full rounded-lg px-4 py-3 focus:outline-none focus:ring-2 resize-none"
                        style="background: ${config.background_color}; font-size: ${fontSize * 0.55}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40; line-height: 1.6;">${window.nouvelleNotes || ''}</textarea>
            </div>
              <div class="rounded-xl p-4" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color};">
                <div class="flex items-center justify-between mb-3">
                  <h3 class="font-display tracking-wider" style="font-size: ${fontSize * 0.75}px; color: ${config.primary_action_color};">ü©∫ PR√âSENCE M√âDICAL : RDV</h3>
                  <button onclick="addPresenceMedical()" 
                          class="rounded-full w-6 h-6 flex items-center justify-center transition-all duration-300 hover:scale-110"
                          style="background: ${config.secondary_action_color}; color: ${config.background_color};">
                    <span style="font-size: ${fontSize * 0.7}px; font-weight: bold;">+</span>
                  </button>
                </div>

                <div class="space-y-2 overflow-auto" style="max-height: 160px;">
                  ${(window.presenceMedicalList || []).map((item) => `
                    <div class="rounded-lg p-3 group" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                      <div class="flex items-start justify-between gap-2">
                        <div class="flex-1">
                          <p style="font-size: ${fontSize * 0.48}px; color: ${config.text_color}; font-weight: 600;">${item.texte}</p>
                          ${item.dateDebut || item.dateFin ? `
                            <p style="font-size: ${fontSize * 0.42}px; color: ${config.text_color}60; margin-top: 4px;">
                              ${item.dateDebut ? new Date(item.dateDebut).toLocaleDateString('fr-FR') : ''} 
                              ${item.dateDebut && item.dateFin ? '‚Üí' : ''} 
                              ${item.dateFin ? new Date(item.dateFin).toLocaleDateString('fr-FR') : ''}
                            </p>
                          ` : ''}
                        </div>
                        <button onclick="deletePresenceMedical('${item.__backendId}')" 
                                class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-5 h-5 flex items-center justify-center hover:scale-110"
                                style="background: ${config.primary_action_color}; color: ${config.text_color};">
                          <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                        </button>
                      </div>
                    </div>
                  `).join('') || `<p style="font-size: ${fontSize * 0.48}px; color: ${config.text_color}60; text-align: center; padding: 10px;">Aucun RDV</p>`}
                </div>
              </div>

            <div class="rounded-xl p-4" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color};">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-display tracking-wider" style="font-size: ${fontSize * 0.8}px; color: ${config.primary_action_color};">üöß VOIES BARR√âES</h3>
                <button onclick="addVoiesBarrees()" 
                        class="rounded-full w-6 h-6 flex items-center justify-center transition-all duration-300 hover:scale-110"
                        style="background: ${config.secondary_action_color}; color: ${config.background_color};">
                  <span style="font-size: ${fontSize * 0.7}px; font-weight: bold;">+</span>
                </button>
              </div>
              <div class="space-y-2 overflow-auto" style="max-height: 500px;">
                ${(window.voiesBarreesList || []).map((item) => `
                  <div class="rounded-lg p-3 group" style="background: ${config.background_color}; border-left: 3px solid ${config.secondary_action_color};">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}; font-weight: 600;">${item.texte}</p>
                        ${item.dateDebut || item.dateFin ? `
                          <p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}60; margin-top: 4px;">
                            ${item.dateDebut ? new Date(item.dateDebut).toLocaleDateString('fr-FR') : ''} 
                            ${item.dateDebut && item.dateFin ? '‚Üí' : ''} 
                            ${item.dateFin ? new Date(item.dateFin).toLocaleDateString('fr-FR') : ''}
                          </p>
                        ` : ''}
                      </div>
                      <button onclick="deleteVoiesBarrees('${item.__backendId}')" 
                              class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-5 h-5 flex items-center justify-center hover:scale-110"
                              style="background: ${config.primary_action_color}; color: ${config.text_color};">
                        <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                      </button>
                    </div>
                  </div>
                `).join('') || `<p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}60; text-align: center; padding: 12px;">Aucune voie barr√©e</p>`}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    window.updateNouvelleNotes = function(value) {
      window.nouvelleNotes = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'nouvelleNotes' && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['nouvelleNotes']) clearTimeout(saveTimeouts['nouvelleNotes']);
        saveTimeouts['nouvelleNotes'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['nouvelleNotes']) clearTimeout(saveTimeouts['nouvelleNotes']);
        saveTimeouts['nouvelleNotes'] = setTimeout(() => saveData('notes', { zone: 'nouvelleNotes', notes: value }), 1000);
      }
    };
// ‚úÖ Pr√©sence m√©dical (RDV)
window.addPresenceMedical = function() {
  const modalHTML = `
    <div id="presence-medical-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.7);">
      <div class="rounded-xl p-6" style="background: ${config.surface_color}; width: 450px; max-width: 90%; border: 2px solid ${config.secondary_action_color};">
        <h3 class="font-display mb-4" style="font-size: ${config.font_size * 0.8}px; color: ${config.text_color};">Pr√©sence m√©dical : RDV</h3>

        <div class="space-y-3">
          <div>
            <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Description :</label>
            <textarea id="presence-medical-texte"
                      placeholder="Ex: RDV m√©decin - 14h30"
                      class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2 resize-none"
                      rows="2"
                      style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;"></textarea>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date d√©but :</label>
              <input type="date" id="presence-medical-date-debut" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2"
                     style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
            </div>
            <div>
              <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date fin :</label>
              <input type="date" id="presence-medical-date-fin" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2"
                     style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
            </div>
          </div>
        </div>

        <div class="flex gap-2 mt-4">
          <button onclick="confirmPresenceMedical()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105"
                  style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${config.font_size * 0.5}px;">
            Ajouter
          </button>
          <button onclick="closePresenceMedicalModal()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105"
                  style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${config.font_size * 0.5}px;">
            Annuler
          </button>
        </div>
      </div>
    </div>
  `;
  const modalDiv = document.createElement('div');
  modalDiv.innerHTML = modalHTML;
  document.body.appendChild(modalDiv.firstElementChild);
};

window.confirmPresenceMedical = async function() {
  const texte = document.getElementById('presence-medical-texte').value.trim();
  const dateDebut = document.getElementById('presence-medical-date-debut').value;
  const dateFin = document.getElementById('presence-medical-date-fin').value;

  if (!texte) {
    showSavingIndicator('‚úó Veuillez saisir une description', true);
    return;
  }

  await saveData('notes', { zone: 'presenceMedicalList', notes: texte, creneau: dateDebut, grade: dateFin });
  closePresenceMedicalModal();
};

window.closePresenceMedicalModal = function() {
  const modal = document.getElementById('presence-medical-modal');
  if (modal) modal.remove();
};

window.deletePresenceMedical = async function(backendId) {
  const record = currentRecords.find(r => String(r.__backendId) === String(backendId));
  if (record) await deleteData(record);
};

    window.addVoiesBarrees = function() {
      const modalHTML = `
        <div id="voies-barrees-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.7);">
          <div class="rounded-xl p-6" style="background: ${config.surface_color}; width: 450px; max-width: 90%; border: 2px solid ${config.secondary_action_color};">
            <h3 class="font-display mb-4" style="font-size: ${config.font_size * 0.8}px; color: ${config.text_color};">Nouvelle Voie Barr√©e</h3>
            
            <div class="space-y-3">
              <div>
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Description :</label>
                <textarea id="voies-barrees-texte" 
                          placeholder="Ex: Rue de la R√©publique - Travaux"
                          class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2 resize-none"
                          rows="2"
                          style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;"></textarea>
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date d√©but :</label>
                  <input type="date" id="voies-barrees-date-debut" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
                </div>
                <div>
                  <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date fin :</label>
                  <input type="date" id="voies-barrees-date-fin" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
                </div>
              </div>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button onclick="confirmVoiesBarrees()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${config.font_size * 0.5}px;">
                Ajouter
              </button>
              <button onclick="closeVoiesBarreesModal()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${config.font_size * 0.5}px;">
                Annuler
              </button>
            </div>
          </div>
        </div>
      `;
      
      const modalDiv = document.createElement('div');
      modalDiv.innerHTML = modalHTML;
      document.body.appendChild(modalDiv.firstElementChild);
    };

    window.confirmVoiesBarrees = async function() {
      const texte = document.getElementById('voies-barrees-texte').value.trim();
      const dateDebut = document.getElementById('voies-barrees-date-debut').value;
      const dateFin = document.getElementById('voies-barrees-date-fin').value;
      
      console.log('üî¥ AJOUT VOIE BARR√âE:', { texte, dateDebut, dateFin });
      
      if (!texte) {
        showSavingIndicator('‚úó Veuillez saisir une description', true);
        return;
      }
      
      if (!dateDebut) {
        showSavingIndicator('‚úó Veuillez saisir au moins une date de d√©but', true);
        return;
      }
      
      await saveData('notes', { zone: 'voiesBarrees', notes: texte, creneau: dateDebut, grade: dateFin });
      console.log('‚úÖ Voie barr√©e sauvegard√©e, liste actuelle:', window.voiesBarreesList);
      closeVoiesBarreesModal();
    };

    window.closeVoiesBarreesModal = function() {
      const modal = document.getElementById('voies-barrees-modal');
      if (modal) modal.remove();
    };

    window.deleteVoiesBarrees = async function(backendId) {
      const bid = Number(backendId);
      const record = currentRecords.find(r => Number(r.__backendId) === bid);
      if (record) {
        await deleteData(record);
      }
    };

    function renderGliSlide() {
      const fontSize = config.font_size;
      
      return `
        <div class="h-full flex flex-col gap-4">
          ${renderCalendarHeader()}
          <h2 class="font-display tracking-wider" style="font-size: ${fontSize * 1.5}px; color: ${config.text_color};">GLI - GROUPEMEMT LOGISTIQUE ET INFRASTRUCTURES</h2>
          
          <div class="grid grid-cols-2 gap-4 flex-1">
            <div class="rounded-xl p-4" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-display tracking-wider" style="font-size: ${fontSize * 0.8}px; color: ${config.secondary_action_color};">üöí ENGINS INDISPONIBLES</h3>
                <button onclick="addEnginsIndispo()" 
                        class="rounded-full w-6 h-6 flex items-center justify-center transition-all duration-300 hover:scale-110"
                        style="background: ${config.secondary_action_color}; color: ${config.background_color};">
                  <span style="font-size: ${fontSize * 0.7}px; font-weight: bold;">+</span>
                </button>
              </div>
              <div class="space-y-2 overflow-auto" style="max-height: 500px;">
                ${(window.enginsIndispoList || []).map((item) => `
                  <div class="rounded-lg p-3 group" style="background: ${config.background_color}; border-left: 3px solid ${config.primary_action_color};">
                    <div class="flex items-start justify-between">
                      <div class="flex-1">
                        <p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}; font-weight: 600;">${item.texte}</p>
                        ${item.dateDebut || item.dateFin ? `
                          <p style="font-size: ${fontSize * 0.45}px; color: ${config.text_color}60; margin-top: 4px;">
                            ${item.dateDebut ? new Date(item.dateDebut).toLocaleDateString('fr-FR') : ''} 
                            ${item.dateDebut && item.dateFin ? '‚Üí' : ''} 
                            ${item.dateFin ? new Date(item.dateFin).toLocaleDateString('fr-FR') : ''}
                          </p>
                        ` : ''}
                      </div>
                      <button onclick="deleteEnginsIndispo('${item.__backendId}')" 
                              class="opacity-0 group-hover:opacity-100 transition-opacity rounded-full w-5 h-5 flex items-center justify-center hover:scale-110"
                              style="background: ${config.primary_action_color}; color: ${config.text_color};">
                        <span style="font-size: ${fontSize * 0.4}px;">√ó</span>
                      </button>
                    </div>
                  </div>
                `).join('') || `<p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}60; text-align: center; padding: 12px;">Aucun engin indisponible</p>`}
              </div>
            </div>

            <div class="rounded-xl p-4" style="background: ${config.surface_color}; border-left: 4px solid ${config.secondary_action_color};">
              <h3 class="font-display tracking-wider mb-3" style="font-size: ${fontSize * 0.8}px; color: ${config.primary_action_color};">üìù NOTES GLI</h3>
              <textarea id="gli-notes-textarea"
                        onchange="updateGliNotes(this.value)"
                        placeholder="Informations diverses sur le mat√©riel et les √©quipements..."
                        class="w-full h-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 resize-none"
                        style="background: ${config.background_color}; font-size: ${fontSize * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40; min-height: 500px;">${window.gliNotes || ''}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    window.addEnginsIndispo = function() {
      const modalHTML = `
        <div id="engins-indispo-modal" class="fixed inset-0 flex items-center justify-center z-50" style="background: rgba(0,0,0,0.7);">
          <div class="rounded-xl p-6" style="background: ${config.surface_color}; width: 450px; max-width: 90%; border: 2px solid ${config.secondary_action_color};">
            <h3 class="font-display mb-4" style="font-size: ${config.font_size * 0.8}px; color: ${config.text_color};">Nouvel Engin Indisponible</h3>
            
            <div class="space-y-3">
              <div>
                <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Description :</label>
                <textarea id="engins-indispo-texte" 
                          placeholder="Ex: FPT 55 en panne - probl√®me moteur"
                          class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2 resize-none"
                          rows="2"
                          style="background: ${config.background_color}; font-size: ${config.font_size * 0.5}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;"></textarea>
              </div>
              
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date d√©but :</label>
                  <input type="date" id="engins-indispo-date-debut" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
                </div>
                <div>
                  <label class="block mb-1" style="font-size: ${config.font_size * 0.5}px; color: ${config.text_color}80;">Date fin estim√©e :</label>
                  <input type="date" id="engins-indispo-date-fin" class="w-full rounded px-3 py-2 focus:outline-none focus:ring-2" style="background: ${config.background_color}; font-size: ${config.font_size * 0.45}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40;">
                </div>
              </div>
            </div>
            
            <div class="flex gap-2 mt-4">
              <button onclick="confirmEnginsIndispo()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${config.font_size * 0.5}px;">
                Ajouter
              </button>
              <button onclick="closeEnginsIndispoModal()" class="flex-1 px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105" style="background: ${config.primary_action_color}; color: ${config.text_color}; font-size: ${config.font_size * 0.5}px;">
                Annuler
              </button>
            </div>
          </div>
        </div>
      `;
      
      const modalDiv = document.createElement('div');
      modalDiv.innerHTML = modalHTML;
      document.body.appendChild(modalDiv.firstElementChild);
    };

    window.confirmEnginsIndispo = async function() {
      const texte = document.getElementById('engins-indispo-texte').value.trim();
      const dateDebut = document.getElementById('engins-indispo-date-debut').value;
      const dateFin = document.getElementById('engins-indispo-date-fin').value;
      
      if (!texte) {
        showSavingIndicator('‚úó Veuillez saisir une description', true);
        return;
      }
      
      await saveData('notes', { zone: 'enginsIndispo', notes: texte, creneau: dateDebut, grade: dateFin });
      closeEnginsIndispoModal();
    };

    window.closeEnginsIndispoModal = function() {
      const modal = document.getElementById('engins-indispo-modal');
      if (modal) modal.remove();
    };

    window.deleteEnginsIndispo = async function(backendId) {
      const bid = Number(backendId);
      const record = currentRecords.find(r => Number(r.__backendId) === bid);
      if (record) {
        await deleteData(record);
      }
    };

    window.updateGliNotes = function(value) {
      window.gliNotes = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'gliNotes' && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['gliNotes']) clearTimeout(saveTimeouts['gliNotes']);
        saveTimeouts['gliNotes'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['gliNotes']) clearTimeout(saveTimeouts['gliNotes']);
        saveTimeouts['gliNotes'] = setTimeout(() => saveData('notes', { zone: 'gliNotes', notes: value }), 1000);
      }
    };

    function renderFormationSlide() {
      const fontSize = config.font_size;
      
      return `
        <div class="h-full flex flex-col">
          ${renderCalendarHeader()}
          <h2 class="font-display tracking-wider mb-4" style="font-size: ${fontSize * 1.5}px; color: ${config.text_color};">FORMATION</h2>
          
          <div class="rounded-xl p-6 flex-1" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
            <textarea id="formation-notes-textarea"
                      onchange="updateFormationNotes(this.value)"
                      placeholder="Informations sur les formations en cours, planifi√©es, ou ÔøΩÔøΩ venir..."
                      class="w-full h-full rounded-lg px-4 py-3 focus:outline-none focus:ring-2 resize-none"
                      style="background: ${config.background_color}; font-size: ${fontSize * 0.55}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40; line-height: 1.6;">${window.formationNotes || ''}</textarea>
          </div>
        </div>
      `;
    }

    window.updateFormationNotes = function(value) {
      window.formationNotes = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'formationNotes' && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['formationNotes']) clearTimeout(saveTimeouts['formationNotes']);
        saveTimeouts['formationNotes'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['formationNotes']) clearTimeout(saveTimeouts['formationNotes']);
        saveTimeouts['formationNotes'] = setTimeout(() => saveData('notes', { zone: 'formationNotes', notes: value }), 1000);
      }
    };

    function renderCommunicationSlide() {
      const fontSize = config.font_size;
      
      return `
        <div class="h-full flex flex-col">
          ${renderCalendarHeader()}
          <h2 class="font-display tracking-wider mb-4" style="font-size: ${fontSize * 1.5}px; color: ${config.text_color};">R√âPONSE OP√âRATIONNELLE / COMMUNICATION</h2>
          
          <div class="rounded-xl p-6 flex-1" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
            <textarea id="reponse-op-notes-textarea"
                      onchange="updateReponseOpNotes(this.value)"
                      placeholder="Informations sur la r√©ponse op√©rationnelle, communications importantes..."
                      class="w-full h-full rounded-lg px-4 py-3 focus:outline-none focus:ring-2 resize-none"
                      style="background: ${config.background_color}; font-size: ${fontSize * 0.55}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40; line-height: 1.6;">${window.reponseOpNotes || ''}</textarea>
          </div>
        </div>
      `;
    }

    window.updateReponseOpNotes = function(value) {
      window.reponseOpNotes = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'reponseOpNotes' && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['reponseOpNotes']) clearTimeout(saveTimeouts['reponseOpNotes']);
        saveTimeouts['reponseOpNotes'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['reponseOpNotes']) clearTimeout(saveTimeouts['reponseOpNotes']);
        saveTimeouts['reponseOpNotes'] = setTimeout(() => saveData('notes', { zone: 'reponseOpNotes', notes: value }), 1000);
      }
    };

    function renderDiversSlide() {
      const fontSize = config.font_size;
      
      return `
        <div class="h-full flex flex-col">
          ${renderCalendarHeader()}
          <h2 class="font-display tracking-wider mb-4" style="font-size: ${fontSize * 1.5}px; color: ${config.text_color};">INFORMATIONS AMICALE</h2>
          
          <div class="rounded-xl p-6 flex-1" style="background: ${config.surface_color}; border-left: 4px solid ${config.primary_action_color};">
            <textarea id="divers-notes-textarea"
                      onchange="updateDiversNotes(this.value)"
                      placeholder="Autres informations diverses..."
                      class="w-full h-full rounded-lg px-4 py-3 focus:outline-none focus:ring-2 resize-none"
                      style="background: ${config.background_color}; font-size: ${fontSize * 0.55}px; color: ${config.text_color}; border: 2px solid ${config.secondary_action_color}40; line-height: 1.6;">${window.diversNotes || ''}</textarea>
          </div>
        </div>
      `;
    }

    window.updateDiversNotes = function(value) {
      window.diversNotes = value;
      const existingRecord = currentRecords.find(r => r.type === 'notes' && r.zone === 'diversNotes' && (weekKeyToMonday(r.weekKey) || weekKeyToMonday(getWeekKey(currentWeekOffset))) === weekKeyToMonday(getWeekKey(currentWeekOffset)));
      if (existingRecord) {
        existingRecord.notes = value;
        if (saveTimeouts['diversNotes']) clearTimeout(saveTimeouts['diversNotes']);
        saveTimeouts['diversNotes'] = setTimeout(() => updateData(existingRecord), 1000);
      } else {
        if (saveTimeouts['diversNotes']) clearTimeout(saveTimeouts['diversNotes']);
        saveTimeouts['diversNotes'] = setTimeout(() => saveData('notes', { zone: 'diversNotes', notes: value }), 1000);
      }
    };

    function renderSlide() {
      const slide = slides[currentSlide];
      const renderers = {
        'garde': renderGardeSlide,
        'verifications': renderVerificationsSlide,
        'activite': renderActiviteSlide,
        'gpro': renderGproSlide,
        'nouvelle': renderNouvelleSlide,
        'gli': renderGliSlide,
        'formation': renderFormationSlide,
        'communication': renderCommunicationSlide,
        'divers': renderDiversSlide
      };
      
      return renderers[slide.id] ? renderers[slide.id]() : '';
    }

    function render() {
      if (!isInitialized) return;
      
      const fontSize = config.font_size;
      const centreName = config.centre_name || defaultConfig.centre_name;
      
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="h-full flex flex-col p-6" style="background: ${config.background_color};">
          <header class="flex items-center justify-between mb-4" style="border-bottom: 3px solid ${config.primary_action_color}; padding-bottom: 0px;">
            <div class="flex items-center gap-3">
              <img src="CHATEAU-GONTIER.png" alt="Logo CIS Ch√¢teau-Gontier" style="height: 180px; width: auto; object-fit: contain; margin-right: 10px;">
              <div>
                <h1 class="font-display tracking-wider mb-1" style="font-size: ${fontSize * 1.8}px; color: ${config.text_color};">${centreName}</h1>
                <p style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}80;">${getCurrentDate()}</p>
              </div>
            </div>
            <div class="text-right">
              <p id="clock" class="font-display" style="font-size: ${fontSize * 2}px; color: ${config.secondary_action_color};">${getCurrentTime()}</p>
            </div>
          </header>

          <div class="flex gap-2 mb-4">
            ${slides.map((slide, index) => `
              <button onclick="goToSlide(${index})"
                      class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105"
                      style="background: ${currentSlide === index ? config.primary_action_color : config.surface_color}; color: ${config.text_color}; font-size: ${fontSize * 0.45}px; border: 2px solid ${currentSlide === index ? config.primary_action_color : config.text_color}40;">
                ${slide.title}
              </button>
            `).join('')}
          </div>

          <div class="flex-1 overflow-auto slide-active">
            ${renderSlide()}
          </div>

          <div class="flex items-center justify-between mt-4" style="border-top: 2px solid ${config.primary_action_color}40; padding-top: 12px;">
            <div class="flex items-center gap-3">
              <button onclick="previousSlide()" 
                      class="px-4 py-2 rounded-lg font-bold transition-all duration-300 hover:scale-110"
                      style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${fontSize * 0.5}px;">
                ‚Üê Pr√©c√©dent
              </button>
              <button onclick="nextSlide()" 
                      class="px-4 py-2 rounded-lg font-bold transition-all duration-300 hover:scale-110"
                      style="background: ${config.secondary_action_color}; color: ${config.background_color}; font-size: ${fontSize * 0.5}px;">
                Suivant ‚Üí
              </button>
            </div>
            
            <div class="flex items-center gap-3">
              <button onclick="toggleAutoPlay()" 
                      class="px-4 py-2 rounded-lg font-semibold transition-all duration-300 hover:scale-105 flex items-center gap-2"
                      style="background: ${isAutoPlaying ? config.primary_action_color : config.surface_color}; color: ${config.text_color}; font-size: ${fontSize * 0.45}px;">
                ${isAutoPlaying ? '‚è∏ Pause' : '‚ñ∂Ô∏è Lecture auto'}
              </button>
              <div class="flex items-center gap-2">
                <span style="font-size: ${fontSize * 0.5}px; color: ${config.text_color}80;">Slide ${currentSlide + 1}/${slides.length}</span>
                <div class="rounded-full overflow-hidden" style="width: 80px; height: 8px; background: ${config.surface_color};">
                  <div id="progress-bar" class="h-full transition-all" style="width: ${(progressValue / SLIDE_DURATION) * 100}%; background: ${config.secondary_action_color};"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      if (slides[currentSlide].id === 'garde') {
        setTimeout(() => setupDragAndDrop(), 0);
      }
      if (slides[currentSlide].id === 'verifications') {
        setTimeout(() => setupVerificationsDragAndDrop(), 0);
      }
    }

    window.goToSlide = function(index) {
      currentSlide = index;
      progressValue = 0;
      if (isAutoPlaying) {
        restartAutoPlay();
      }
      render();
    };

    window.nextSlide = function() {
      currentSlide = (currentSlide + 1) % slides.length;
      progressValue = 0;
      if (isAutoPlaying) {
        restartAutoPlay();
      }
      render();
    };

    window.previousSlide = function() {
      currentSlide = (currentSlide - 1 + slides.length) % slides.length;
      progressValue = 0;
      if (isAutoPlaying) {
        restartAutoPlay();
      }
      render();
    };

    window.toggleAutoPlay = function() {
      isAutoPlaying = !isAutoPlaying;
      if (isAutoPlaying) {
        startAutoPlay();
      } else {
        stopAutoPlay();
      }
      render();
    };

    function startAutoPlay() {
      progressValue = 0;
      progressStartTime = Date.now();
      
      autoPlayInterval = setInterval(() => {
        nextSlide();
      }, SLIDE_DURATION);
      
      updateProgress();
    }

    function updateProgress() {
      if (!isAutoPlaying) return;
      
      const elapsed = Date.now() - progressStartTime;
      progressValue = Math.min(elapsed, SLIDE_DURATION);
      
      const progressBar = document.getElementById('progress-bar');
      if (progressBar) {
        progressBar.style.width = `${(progressValue / SLIDE_DURATION) * 100}%`;
      }
      
      if (progressValue < SLIDE_DURATION) {
        progressAnimationFrame = requestAnimationFrame(updateProgress);
      }
    }

    function stopAutoPlay() {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
        autoPlayInterval = null;
      }
      if (progressAnimationFrame) {
        cancelAnimationFrame(progressAnimationFrame);
        progressAnimationFrame = null;
      }
      progressValue = 0;
    }

    function restartAutoPlay() {
      stopAutoPlay();
      startAutoPlay();
    }

    const dataHandler = {
      onDataChanged(data) {
        currentRecords = data;
        loadDataFromRecords(data);
        if (isInitialized) {
          render();
        }
      }
    };

    async function onConfigChange(newConfig) {
      Object.assign(config, newConfig);
      if (isInitialized) {
        render();
      }
    }

    async function init() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize data SDK:', result.error);
        }
      }

      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              { get: () => config.background_color, set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); } },
              { get: () => config.surface_color, set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); } },
              { get: () => config.text_color, set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); } },
              { get: () => config.primary_action_color, set: (v) => { config.primary_action_color = v; window.elementSdk.setConfig({ primary_action_color: v }); } },
              { get: () => config.secondary_action_color, set: (v) => { config.secondary_action_color = v; window.elementSdk.setConfig({ secondary_action_color: v }); } }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: { get: () => config.font_size, set: (v) => { config.font_size = v; window.elementSdk.setConfig({ font_size: v }); } }
          }),
          mapToEditPanelValues: (config) => new Map([
            ['centre_name', config.centre_name]
          ])
        });
        config = window.elementSdk.config;
      }

      isInitialized = true;
      render();
      startClock();
      startAutoPlay();
    }

    init();
  </script>
 </body>
</html>